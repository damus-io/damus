{"id":"damus-dhj","title":"Fix RelayConnection freeze when disconnecting relays","description":"## Problem\nApp freezes when disconnecting from relays. Discovered while testing the relay list disco fix.\n\n## Root Cause\n`RelayConnection` class has `@Published` properties (`isConnected`, `isConnecting`) that were being updated from background threads. Combine's `@Published` property wrapper requires main thread updates - violating this causes undefined behavior and deadlocks.\n\nConsole warnings showed:\n- 'Publishing changes from background threads is not allowed'\n- 'Updating ObservedObject\u003cRelayConnection\u003e from background threads will cause undefined behavior'\n\nStack trace showed freeze in `__ulock_wait2` called from `RelayConnection.disconnect()` → `isConnected` setter.\n\n## Fix\nUpdated `connect()`, `disconnect()`, and `ping()` to ensure `@Published` properties are updated on main thread:\n- Check `Thread.isMainThread` to avoid unnecessary async dispatch\n- Use `DispatchQueue.main.async` when called from background thread\n- Maintains proper ordering for `reconnect()` flow (disconnect → connect)\n\n## Files Changed\n- `damus/Core/Nostr/RelayConnection.swift`\n\n## Testing\n- Run app, go to relay detail view, tap Disconnect\n- Should no longer freeze\n- Watch for console warnings about background thread updates (should be gone)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T13:55:58.835838-06:00","created_by":"e","updated_at":"2026-01-16T14:02:01.448667-06:00","closed_at":"2026-01-16T14:02:01.448667-06:00","close_reason":"Closed","dependencies":[{"issue_id":"damus-dhj","depends_on_id":"damus-wb4","type":"relates-to","created_at":"2026-01-16T13:57:33.616863-06:00","created_by":"daemon"}],"comments":[{"id":2,"issue_id":"damus-dhj","author":"e","text":"## Lessons Learned\n\n1. **@Published requires main thread**: Combine's `@Published` property wrapper publishes changes through Combine pipelines. Updating from background threads causes lock contention and deadlocks.\n\n2. **Console warnings are critical**: The 'Publishing changes from background threads is not allowed' warning was the key diagnostic. Always check console during debugging.\n\n3. **Use Thread.isMainThread check**: When a function can be called from either main or background thread, check `Thread.isMainThread` before deciding whether to dispatch async. Avoids unnecessary async dispatch and maintains proper ordering.\n\n4. **ObservableObject + background work = careful**: Any `ObservableObject` with `@Published` properties that does async/background work needs careful main thread management.\n\n## Related\n- This bug was discovered while testing damus-wb4 (relay list disco fix)\n- Pre-existing bug, not caused by disco fix changes","created_at":"2026-01-16T19:56:10Z"},{"id":4,"issue_id":"damus-dhj","author":"e","text":"✅ VERIFIED: No more freeze when disconnecting/reconnecting relays.","created_at":"2026-01-16T19:57:43Z"}]}
{"id":"damus-wb4","title":"Fix relay list disco bug (flickering UI)","description":"## Problem\nRelay list UI was flickering ('disco') and users couldn't remove relays. Reported in https://github.com/damus-io/damus/issues/3537\n\n## Root Cause\nRace condition in `UserRelayListManager.set()` - the `latestRelayListEventIdHex` was updated AFTER sending the event to the pool. This allowed `listenAndHandleRelayUpdates()` to receive and re-process the same event before the state was updated, causing multiple `notify(.relays_changed)` and UI flickering.\n\nAdditionally, the same event arriving from multiple relays simultaneously could be processed multiple times.\n\n## Fix\n1. Added `latestRelayListCreatedAt` property to track timestamps locally (not via NostrDB lookup)\n2. Update timestamp BEFORE sending event to pool\n3. Update timestamp immediately when processing incoming events (before calling set())\n4. Initialize timestamp from stored relay list on load()\n\n## Files Changed\n- `damus/Core/Networking/NostrNetworkManager/UserRelayListManager.swift`\n\n## Testing\n- Debug logging added to verify fix: `[relay-list] Skipping already-known relay list event`\n- All events now show 'Skipping' instead of duplicate 'Processing' messages","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T09:21:37.388845-06:00","created_by":"e","updated_at":"2026-01-16T14:02:01.401587-06:00","closed_at":"2026-01-16T14:02:01.401587-06:00","close_reason":"Closed","dependencies":[{"issue_id":"damus-wb4","depends_on_id":"damus-dhj","type":"relates-to","created_at":"2026-01-16T13:57:33.615354-06:00","created_by":"daemon"}],"comments":[{"id":1,"issue_id":"damus-wb4","author":"e","text":"## Lessons Learned\n\n1. **Race conditions in event-driven systems**: When sending events that can echo back (e.g., via relay broadcast), always update local state BEFORE sending. The listener needs to know about the event before it receives it.\n\n2. **NostrDB lookups can fail during race windows**: The original code looked up the event from NostrDB to get its timestamp, but the event wasn't written yet. Solution: store the timestamp locally.\n\n3. **Multiple relays = multiple deliveries**: The same event can arrive from multiple relays nearly simultaneously. Need to deduplicate by updating state immediately when processing (not after async operations).\n\n4. **Debug logging is essential**: Added `[relay-list]` prefixed logs to verify the fix works. Shows 'Skipping' for duplicates, 'Processing' for new events.","created_at":"2026-01-16T19:55:48Z"},{"id":3,"issue_id":"damus-wb4","author":"e","text":"✅ VERIFIED: Fix working. All logs show 'Skipping already-known relay list event' - no duplicate 'Processing' messages.","created_at":"2026-01-16T19:57:43Z"}]}
