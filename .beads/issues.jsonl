{"id":"damus-02i","title":"Automate poor connectivity tests for all other app flows","description":"Investigate and implement automated testing for non-upload app flows under poor network conditions. This covers relay connections, event fetching, profile loading, etc.\n\nAreas to cover:\n- Relay connection/reconnection under packet loss\n- Event fetching with high latency\n- Profile/metadata loading with intermittent connectivity\n- Timeline scrolling during network degradation\n- DM sending/receiving with poor connectivity\n- Zap flows under network stress\n\nQuestions to answer:\n- Can we mock WebSocket connections for relay testing?\n- How do we test graceful degradation of the UI?\n- Should we create a test harness that wraps network calls?\n- Can we leverage existing Ndb test infrastructure?\n\nDepends on learnings from: damus-2qb (media upload automation)","notes":"## Progress Update (2026-01-03)\n\n### Completed Infrastructure\n- Phase 1: MockWebSocket + RelayConnectionTests (19 unit tests)\n- Phase 2: RelayIntegrationTests with strfry + NIP-01 (8 integration tests)\n- CI workflow with sitespeedio/throttle\n- damus-cfl: Local Relay Model investigation complete\n\n### Current Work\n- damus-3p2: RelayPool multi-relay coordination tests (in progress)\n\n### Architecture Understanding\nFeatures -\u003e NostrNetworkManager -\u003e SubscriptionManager -\u003e RelayPool -\u003e RelayConnection -\u003e WebSocket\n\nStream modes: ndbFirst, ndbAndNetworkParallel, ndbOnly\n\n### Remaining Feature Coverage\n| Bead | Feature | Priority | Status |\n|------|---------|----------|--------|\n| damus-3p2 | RelayPool | P2 | In Progress |\n| damus-rrq | Posting Notes | P2 | Pending |\n| damus-1ct | Timeline | P2 | Pending |\n| damus-uwn | DMs | P2 | Pending |\n| damus-b6g | Zaps | P2 | Pending |\n| damus-0o9 | Profile | P2 | Pending |\n| damus-2zx | Search | P3 | Pending |","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T14:31:04.329626-06:00","created_by":"e","updated_at":"2026-01-03T22:16:34.70438-06:00","labels":["automation","network testing"],"comments":[{"id":19,"issue_id":"damus-02i","author":"e","text":"## Phase 3 Complete (2026-01-03)\n\n### damus-3p2: RelayPool Multi-Relay Tests ✅\nCommit: 87958fc8\n\nAdded 8 tests for multi-relay coordination:\n- testMultipleRelaysConnect\n- testNumConnectedTracksState  \n- testPartialRelayFailure\n- testRelayDisconnectDoesNotAffectOthers\n- testMessageSentToAllRelays\n- testMessagesQueuedWhenDisconnected\n- testQueuedMessagesSentOnConnect\n- testPoolHandlesReconnection\n\nModified RelayPool.add_relay() to accept injectable WebSocketProtocol.\n\n### Updated Progress\n| Bead | Feature | Status |\n|------|---------|--------|\n| damus-3p2 | RelayPool | ✅ Complete |\n| damus-rrq | Posting Notes | Pending |\n| damus-1ct | Timeline | Pending |\n| damus-uwn | DMs | Pending |\n| damus-b6g | Zaps | Pending |\n| damus-0o9 | Profile | Pending |\n| damus-2zx | Search | Pending |","created_at":"2026-01-04T04:35:40Z"},{"id":20,"issue_id":"damus-02i","author":"e","text":"## Phase 4 Complete (2026-01-03)\n\n### PostBox + EventHolder Tests ✅\nCommit: 2c655f93\n\n**PostBoxTests (17 tests):**\n- Event queuing and OK response handling\n- Multi-relay coordination\n- on_flush callbacks (.once/.all)\n- Delayed send + cancel\n- Retry with exponential backoff\n\n**EventHolderTests (13 tests):**\n- Queue vs immediate insert\n- Deduplication\n- Flush and ordering\n- Reset behavior\n\n### Updated Progress\n| Bead | Feature | Status |\n|------|---------|--------|\n| damus-3p2 | RelayPool | ✅ Complete |\n| damus-rrq | Posting/PostBox | ✅ Complete |\n| damus-1ct | Timeline/EventHolder | ✅ Complete |\n| damus-cfl | Investigation | ✅ Complete |\n| damus-uwn | DMs | Pending |\n| damus-b6g | Zaps | Pending |\n| damus-0o9 | Profile | Pending |\n| damus-2zx | Search | Pending |","created_at":"2026-01-04T04:58:57Z"}]}
{"id":"damus-0o9","title":"Profile Updates: Add poor network testing for metadata event publishing","description":"Add automated tests for profile updates under poor network conditions.\n\n## Context\nProfile edits (name, picture, about, NIP-05) use kind 0 metadata events. User edits but changes don't persist = frustrating UX.\n\n## Test Scenarios\n- Profile update succeeds under 3G\n- Profile shows saving state during slow network\n- Profile update retry after failure\n- Profile reverts to previous on permanent failure\n- Multiple rapid edits coalesced into single publish\n- Large profile picture URL handling\n- NIP-05 verification during slow network\n\n## NIP-01 Messages\n- Client sends: [\\EVENT\\, {kind: 0, content: JSON metadata}]\n- Relay responds: [\\OK\\, \u003cevent_id\u003e, true/false, \u003cmessage\u003e]\n\n## Files to Test\n- `damus/Features/Profile/` directory\n- Metadata/profile models\n\n## Approach\n1. MockWebSocket for unit tests\n2. Verify profile state: editing → saving → saved/failed\n3. Test rollback behavior on failure","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:00:51.29286-06:00","created_by":"e","updated_at":"2026-01-05T15:02:06.671192-06:00","closed_at":"2026-01-05T15:02:06.671194-06:00","labels":["network","profile","testing"]}
{"id":"damus-0pj","title":"Code Requirements for Image Upload Fixes","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-03T12:46:37.113908-06:00","created_by":"e","updated_at":"2026-01-03T12:46:37.113908-06:00","labels":["documentation","standards"],"comments":[{"id":1,"issue_id":"damus-0pj","author":"e","text":"## Code Requirements\n\nAll implementation work for image upload fixes must follow these standards:\n\n### 1. Logically Distinct Commits\n- Each commit should address ONE logical change\n- Don't mix refactoring with bug fixes\n- Don't mix feature additions with cleanup\n\n### 2. Standalone Commits  \n- Each commit must be independently revertable\n- No commit should create dependencies that break if removed\n- Design for easy cherry-picking or reverting tens of commits later\n\n### 3. Human Readable \u0026 Reviewable Code\n- Code must be clear and understandable by human reviewers\n- Avoid clever/obscure patterns - prefer explicit over implicit\n- Before proposing changes, analyze if nostrdb upgrades would benefit the change\n\n### 4. Docstring Coverage\n- All new functions must have docstrings explaining purpose, parameters, return values\n- All modified functions must have updated docstrings if behavior changes\n- Document non-obvious logic inline\n\n### 5. Performance Requirements\n- No bottlenecks or performance regressions\n- Profile any code that runs on main thread\n- Consider async/background execution for heavy operations\n- Document any performance considerations in code comments\n\n---\n\nThese requirements apply to all linked beads.","created_at":"2026-01-03T18:46:48Z"}]}
{"id":"damus-0tg","title":"Thread Loading: Add poor network testing for reply chain fetching","description":"Add network tests for loading thread/reply chains under poor network conditions. Test fetching parent events, child replies, and handling partial thread data when some relays timeout.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T15:52:00.668472-06:00","created_by":"e","updated_at":"2026-01-05T16:12:10.979291-06:00","closed_at":"2026-01-05T16:12:10.979294-06:00","labels":["network","testing","threads"]}
{"id":"damus-1ct","title":"Timeline/HomeModel: Add poor network testing for event fetching and display","description":"Add automated tests for timeline loading under poor network conditions.\n\n## Context\nTimeline loading depends on RelayPool and RelayConnection, which now have basic test coverage (Phase 1 \u0026 2). This bead covers testing the higher-level HomeModel behavior.\n\n## Test Scenarios\n- Timeline loads successfully under 3G conditions (high latency)\n- Timeline shows cached content when network unavailable\n- Stale content indicator appears when refresh fails\n- Infinite scroll works under intermittent connectivity\n- Pull-to-refresh recovers from network failures\n- Multiple subscription handling during reconnection\n- EOSE timeout handling (REQ sent but no response)\n\n## Files to Test\n- `damus/Features/Timeline/Models/HomeModel.swift`\n- `damus/Features/Home/Views/HomeView.swift`\n\n## Dependencies\n- Requires: MockWebSocket (Phase 1) ✅\n- Requires: RelayIntegrationTests patterns (Phase 2) ✅\n- Related: damus-02i (parent task)\n\n## Approach\n1. Create HomeModelTests.swift with mock relay connections\n2. Inject MockWebSocket to simulate delayed/failed responses\n3. Verify UI state transitions (loading → content → error)\n4. Test with sitespeedio/throttle for integration tests","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:00:28.167458-06:00","created_by":"e","updated_at":"2026-01-03T22:58:38.389707-06:00","closed_at":"2026-01-03T22:58:38.389707-06:00","close_reason":"Added 13 EventHolder tests covering queue/immediate modes, deduplication, flush behavior, event ordering, and reset. EventHolder is the core timeline data structure. Commit: 2c655f93","labels":["network","testing","timeline"]}
{"id":"damus-2qb","title":"Automate poor connectivity tests for media upload flow","description":"Investigate and implement automated testing for media uploads under poor network conditions. Currently we have unit tests with MockURLProtocol, but need to explore integration/UI testing approaches.\n\nQuestions to answer:\n- Can XCUITest simulate network conditions programmatically?\n- Should we use a local proxy (Charles, mitmproxy) for more realistic simulation?\n- Can we trigger Network Link Conditioner profiles from test code?\n- What about testing partial uploads / resume after reconnection?\n- How do we test the UI feedback (progress indicators, error messages) under poor network?\n\nRelated: Unit tests exist in UploadRetryTests.swift using MockURLProtocol","notes":"Implemented NetworkConditionSimulator for UI testing. Added example tests and documentation in DEV_TIPS.md. Supports timeout, connectionLost, notConnected, slowNetwork, failThenSucceed, and serverError conditions via launch arguments.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T14:30:51.875782-06:00","created_by":"e","updated_at":"2026-01-03T14:55:25.64149-06:00","closed_at":"2026-01-03T14:55:25.641492-06:00","labels":["automation","media upload","network testing"]}
{"id":"damus-2zx","title":"Search: Add poor network testing for relay queries","description":"Add automated tests for search under poor network conditions.\n\n## Context  \nSearch queries relays for content. Slow network = long wait, no results, or partial results.\n\n## Test Scenarios\n- Search returns results under 3G\n- Search shows loading state appropriately\n- Search timeout with user-friendly message\n- Partial results displayed as they arrive\n- Search cancellation during slow query\n- Multiple search queries (user types fast)\n\n## NIP-50 Search\n- REQ with 'search' filter field\n- Not all relays support NIP-50\n\n## Files to Test\n- `damus/Features/Search/` directory\n- Search models and views\n\n## Approach\n1. MockWebSocket for unit tests\n2. Verify search state: searching → results/empty/error\n3. Lower priority than posting/DMs (P3)","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-03T22:00:51.445407-06:00","created_by":"e","updated_at":"2026-01-05T15:27:31.991628-06:00","closed_at":"2026-01-05T15:27:31.991631-06:00","labels":["network","search","testing"]}
{"id":"damus-3n4","title":"MEDIUM: MediaPicker failedCount race condition - use serial queue or main thread for thread safety","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T17:01:11.732899-06:00","created_by":"e","updated_at":"2026-01-03T17:04:18.167195-06:00","closed_at":"2026-01-03T17:04:18.167195-06:00","close_reason":"Added DispatchQueue.main.async for thread safety"}
{"id":"damus-3p2","title":"RelayPool: Add comprehensive multi-relay coordination tests","description":"Add comprehensive tests for RelayPool multi-relay coordination.\n\n## Context\nRelayPool is an Actor managing multiple RelayConnections. Current tests cover single-relay scenarios. Need multi-relay coordination tests.\n\n## Test Scenarios\n- Request routed to multiple relays simultaneously\n- Partial relay failure (2/5 succeed)\n- All relays fail → error surfaced to caller\n- Relay priority/preference handling\n- Subscription deduplication across relays\n- Event deduplication from multiple relays\n- Reconnection coordination (don't spam all at once)\n- Request queuing during reconnection\n- Relay health tracking and failover\n\n## Files to Test\n- `damus/Core/Nostr/RelayPool.swift`\n- Relay selection/routing logic\n\n## Approach\n1. Create multiple MockWebSocket instances\n2. Inject into RelayPool with multiple RelayConnections\n3. Simulate various failure patterns\n4. Verify request routing and response aggregation\n\n## Dependencies\n- Requires: MockWebSocket (Phase 1) ✅\n- Extends: RelayConnectionTests ✅","notes":"## Progress Update (2026-01-03)\n\n### Prerequisites Complete\n- damus-cfl investigation done - understand Local Relay Model architecture\n- MockWebSocket ready from Phase 1\n- Existing test patterns identified in NostrNetworkManagerTests\n\n### Architecture Context\nRelayPool sits between SubscriptionManager and RelayConnection:\n  SubscriptionManager.advancedStream()\n      ↓\n  RelayPool.subscribe() ← Test this layer\n      ↓\n  RelayConnection (uses WebSocket)\n\n### Implementation Approach\n1. Modify RelayPool to accept injectable RelayConnections with MockWebSocket\n2. Create RelayPoolTests.swift with multi-relay scenarios\n3. Test partial failures, deduplication, EOSE coordination\n\n### Key RelayPool Methods to Test\n- subscribe() - returns AsyncStream of events\n- send() - routes to multiple relays\n- handle_event() - processes incoming events\n- run_queue() - handles queued requests on reconnect\n- resubscribeAll() - resubscribes after reconnect","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:00:51.573091-06:00","created_by":"e","updated_at":"2026-01-03T22:35:14.639688-06:00","closed_at":"2026-01-03T22:35:14.639688-06:00","close_reason":"Implemented 8 multi-relay coordination tests with MockWebSocket injection. Tests cover: connection management, partial failures, message routing, queuing, and reconnection handling. Commit: 87958fc8","labels":["network","relay","testing"]}
{"id":"damus-3qq","title":"TESTING: Add unit test for 4xx don't-retry behavior in UploadRetryTests","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T17:22:49.226504-06:00","created_by":"e","updated_at":"2026-01-03T18:04:38.961339-06:00","closed_at":"2026-01-03T18:04:38.961339-06:00","close_reason":"fixed"}
{"id":"damus-5xd","title":"Add automated tests for upload fixes - HEIC, TSan, media picker","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T18:09:57.681549-06:00","created_by":"e","updated_at":"2026-01-05T16:14:01.353479-06:00","closed_at":"2026-01-05T16:14:01.353482-06:00"}
{"id":"damus-63x","title":"Propagate server error messages in getMediaURL() instead of returning nil","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:45:04.739442-06:00","created_by":"e","updated_at":"2026-01-03T12:53:57.312452-06:00","closed_at":"2026-01-03T12:53:57.312452-06:00","close_reason":"Closed","labels":["bug","error-handling","media"],"dependencies":[{"issue_id":"damus-63x","depends_on_id":"damus-tah","type":"relates-to","created_at":"2026-01-03T12:45:45.299497-06:00","created_by":"daemon"},{"issue_id":"damus-63x","depends_on_id":"damus-uya","type":"relates-to","created_at":"2026-01-03T12:45:45.322675-06:00","created_by":"daemon"},{"issue_id":"damus-63x","depends_on_id":"damus-r77","type":"relates-to","created_at":"2026-01-03T12:45:45.344668-06:00","created_by":"daemon"},{"issue_id":"damus-63x","depends_on_id":"damus-0pj","type":"parent-child","created_at":"2026-01-03T12:47:07.207933-06:00","created_by":"daemon"}],"comments":[{"id":2,"issue_id":"damus-63x","author":"e","text":"In MediaUploader.swift:117-120, when server returns error status with message, the message is only printed to console and nil is returned. This causes all server errors (rate limits, file size limits, auth failures) to show generic 'Error uploading image :(' instead of actual message.\n\nFix: Change getMediaURL() to return Result\u003cString, UploadError\u003e instead of String?\n\nRelated GitHub issues: #3484, #1286\nFiles: MediaUploader.swift, AttachMediaUtility.swift","created_at":"2026-01-03T18:45:31Z"},{"id":3,"issue_id":"damus-63x","author":"e","text":"## Implementation Complete\n\n### Changes Made:\n\n**1. MediaUploader.swift**\n- Added `UploadError` enum with typed error cases:\n  - `.serverError(message:)` - captures server error messages\n  - `.jsonParsingFailed` - response parsing failures\n  - `.missingURL` - no URL in response\n  - `.networkError(underlying:)` - network failures\n  - `.fileReadError(underlying:)` - file access issues\n  - `.invalidAPIURL` - malformed API URL\n  - `.noMediaData` - missing media data\n- Added `userMessage` property for localized user-facing messages\n- Changed `getMediaURL()` from `String?` to `Result\u003cString, UploadError\u003e`\n\n**2. AttachMediaUtility.swift**\n- Changed `ImageUploadResult.failed` from `Error?` to `UploadError`\n- All failure paths now use typed errors\n- Added comprehensive docstrings\n\n**3. ImageUploadModel.swift**\n- Updated to handle `UploadError` type\n- Cancellation detection now checks inside `.networkError`\n\n**4. PostView.swift**\n- Now displays `error.userMessage` instead of generic string\n- Removed generic \"Error uploading image :(\" fallback\n\n**5. EditPictureControl.swift**\n- Now displays actual error message from server\n- Added docstring\n\n### Result:\nUsers will now see actual error messages like:\n- \"File size exceeds 25MB limit\" (server error)\n- \"The network connection was lost\" (network error)\n- \"Failed to read file: ...\" (file error)\n\nInstead of: \"Error uploading image :(\"","created_at":"2026-01-03T18:53:53Z"}]}
{"id":"damus-85i","title":"Reactions/Likes: Add poor network testing for kind 7 event delivery","description":"Add network tests for reaction/like events under poor network conditions. Test kind 7 event publishing, PostBox integration, and multi-relay broadcast behavior when connections are unstable.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T15:52:00.440494-06:00","created_by":"e","updated_at":"2026-01-05T16:04:29.355894-06:00","closed_at":"2026-01-05T16:04:29.355896-06:00","labels":["network","reactions","testing"]}
{"id":"damus-8su","title":"TESTING: UI tests only verify app launches - should exercise upload and assert error/progress UI","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-03T17:01:11.847426-06:00","created_by":"e","updated_at":"2026-01-03T17:01:11.847426-06:00"}
{"id":"damus-96t","title":"Boosts/Reposts: Add poor network testing for kind 6 event delivery","description":"Add network tests for boost/repost events under poor network conditions. Test kind 6 event publishing and ensure reposts are properly broadcast across relays with connection issues.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T15:52:00.551306-06:00","created_by":"e","updated_at":"2026-01-05T16:04:29.385436-06:00","closed_at":"2026-01-05T16:04:29.38544-06:00","labels":["boosts","network","testing"]}
{"id":"damus-an6","title":"Poor connection simulation testing for entire app (after image upload testing validated)","notes":"Superseded by damus-2qb (media upload) and damus-02i (all other flows). Media upload testing implemented with NetworkConditionSimulator.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:45:05.269054-06:00","created_by":"e","updated_at":"2026-01-03T14:55:31.569252-06:00","closed_at":"2026-01-03T14:55:31.569255-06:00","labels":["network","testing"],"dependencies":[{"issue_id":"damus-an6","depends_on_id":"damus-k5j","type":"blocks","created_at":"2026-01-03T12:45:38.52696-06:00","created_by":"daemon"},{"issue_id":"damus-an6","depends_on_id":"damus-0pj","type":"parent-child","created_at":"2026-01-03T12:47:07.214163-06:00","created_by":"daemon"}],"comments":[{"id":4,"issue_id":"damus-an6","author":"e","text":"After validating poor connection testing works for image uploads (damus-k5j), expand testing to cover:\n- Relay connections\n- Profile loading\n- Note fetching\n- Zaps/Lightning\n- DMs\n\nUse Network Link Conditioner or similar to simulate various network conditions app-wide.","created_at":"2026-01-03T18:45:32Z"}]}
{"id":"damus-b6g","title":"Zaps: Add poor network testing for Lightning payment + event coordination","description":"Add automated tests for Zap flow under poor network conditions.\n\n## Context\nZaps involve coordination between:\n1. Lightning payment (external)\n2. Zap receipt event (kind 9735) published to relay\n\nUser pays but zap not recorded = money lost + no acknowledgment.\n\n## Test Scenarios\n- Zap succeeds under 3G conditions\n- Zap payment succeeds but event publish fails → retry\n- Zap receipt appears after reconnection\n- Multiple zaps queued during offline → sent on reconnect\n- Zap request (kind 9734) timeout handling\n- Invoice fetch under slow network\n\n## Related NIPs\n- NIP-57: Lightning Zaps\n- Kind 9734: Zap request\n- Kind 9735: Zap receipt\n\n## Files to Test\n- `damus/Features/Zaps/` directory\n- Wallet connection code\n\n## Approach\n1. Mock wallet responses for unit tests\n2. MockWebSocket for relay interaction\n3. Verify zap appears after full flow completes\n4. Test recovery when partial flow fails","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:00:51.13554-06:00","created_by":"e","updated_at":"2026-01-05T15:02:06.580494-06:00","closed_at":"2026-01-05T15:02:06.580498-06:00","labels":["network","testing","zaps"]}
{"id":"damus-bvg","title":"Follow/Unfollow: Add poor network testing for contact list publishing","description":"Add network tests for follow/unfollow operations under poor network conditions. Test contact list (kind 3) event publishing delays, retries, and conflict resolution when multiple relays have different states.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T15:52:00.335264-06:00","created_by":"e","updated_at":"2026-01-05T16:04:29.415451-06:00","closed_at":"2026-01-05T16:04:29.415454-06:00","labels":["follow","network","testing"]}
{"id":"damus-cfl","title":"Investigate: Relate network testing to Local Relay Model upgrade (PR #3204, #3291)","description":"Investigation of Local Relay Model architecture and testing implications.\n\n## Current Architecture (as of master)\n\n### Layer Diagram\n\nFeatures (HomeModel, SearchModel, ProfileModel, etc.)\n    ↓\nNostrNetworkManager\n    ├── reader: SubscriptionManager ← Orchestrates data sources\n    │       ├── NostrDB (local cache)\n    │       └── RelayPool → Network\n    ├── postbox: PostBox ← Sends notes\n    ├── userRelayList: UserRelayListManager\n    └── profilesManager: ProfilesManager\n\n### Key Files\n- NostrNetworkManager.swift - Top-level coordinator\n- SubscriptionManager.swift - Data streaming orchestration (500+ lines)\n- RelayPool.swift - Multi-relay connection management\n- RelayConnection.swift - Single relay WebSocket wrapper\n\n---\n\n## SubscriptionManager Deep Dive\n\n### Stream Modes (from code)\n1. ndbFirst - Local cache primary, network fallback\n2. ndbAndNetworkParallel - Both stream simultaneously (most common)\n3. ndbOnly - Ignores network entirely\n\n### Key Methods\n- streamExistingEvents() - Stream until EOSE\n- streamIndefinitely() - Continuous stream\n- advancedStream() - Full control with stream mode\n- lookup() - Find specific events\n- query() - Run filters\n\n### How Features Use It\nHomeModel example:\n  reader.advancedStream(filters: home_filters, \n    streamMode: .ndbAndNetworkParallel(optimizeNetworkFilter: true))\n\n---\n\n## Existing Test Infrastructure\n\n### What Already Exists\n1. MockDamusState - Creates test DamusState with Ndb.test\n2. MockWebSocket - Our Phase 1 creation (RelayConnection mocking)\n3. MockSubscriptionManager - In NostrNetworkManagerTests.swift\n4. Tests use .ndbOnly mode to avoid network dependency\n\n### Test Location\ndamusTests/NostrNetworkManagerTests/\n  - NostrNetworkManagerTests.swift\n  - ProfilesManagerTests.swift\n  - ThreadModelTests.swift\n  - AppLifecycleHandlingTests.swift\n\n---\n\n## Testing Implications\n\n### Our MockWebSocket Position in Stack\n\n[Features] ← Not tested for poor network\n    ↓\n[SubscriptionManager] ← MockSubscriptionManager exists\n    ↓\n[RelayPool] ← Can inject MockWebSocket via RelayConnection\n    ↓\n[RelayConnection] ← Tested with MockWebSocket (19 tests)\n    ↓\n[WebSocket] ← MockWebSocket\n\n### What We Can Test Now\n1. RelayConnection behavior (done - 19 tests)\n2. RelayPool with multiple MockWebSockets\n3. Features with MockSubscriptionManager (bypass network)\n\n### Gap: SubscriptionManager Orchestration\nNo tests for:\n- Stream mode switching behavior\n- NDB + Network race conditions\n- EOSE coordination between sources\n- Filter optimization logic\n\n---\n\n## Recommendations for Testing\n\n### Option 1: Test at RelayPool level\nInject MockWebSocket into RelayPool to test:\n- Multi-relay coordination\n- Partial failures\n- Event deduplication\nThis is damus-3p2\n\n### Option 2: Test at SubscriptionManager level\nUse existing MockSubscriptionManager pattern to test:\n- Feature behavior under simulated conditions\n- Response to various stream items\n\n### Option 3: Test SubscriptionManager internals\nCreate tests for orchestration logic:\n- ndbFirst vs ndbAndNetworkParallel behavior\n- EOSE timing\n- Filter optimization\n\n---\n\n## Action Items\n- [x] Read SubscriptionManager.swift\n- [x] Understand stream modes\n- [x] Map data flow from features to network\n- [x] Identify existing test infrastructure\n- [ ] Proceed with damus-3p2 (RelayPool tests)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:07:36.1128-06:00","created_by":"e","updated_at":"2026-01-03T22:58:44.933022-06:00","closed_at":"2026-01-03T22:58:44.933022-06:00","close_reason":"Investigation complete. Documented Local Relay Model architecture: Features → NostrNetworkManager → SubscriptionManager → RelayPool → RelayConnection → WebSocket. Stream modes and test patterns identified.","labels":["investigation","local-relay","testing"]}
{"id":"damus-czv","title":"Extend NetworkConditionSimulator to WebSocket/relay connections","description":"Extend the NetworkConditionSimulator infrastructure to support WebSocket connections used by Nostr relays.\n\nCurrent state:\n- NetworkConditionSimulator intercepts URLSession (HTTP/HTTPS) requests\n- Works well for media uploads to services like nostr.build\n- Does NOT intercept WebSocket connections\n\nChallenge:\n- Nostr uses WSS (WebSocket Secure) for all relay communication\n- URLProtocol only intercepts HTTP, not WebSocket\n- Need different approach for WebSocket simulation\n\nPossible approaches:\n1. **Mock at RelayConnection level** - Inject mock relay connections that simulate failures\n2. **Proxy approach** - Route WebSocket through local proxy that introduces failures\n3. **NWConnection interception** - If using Network.framework, may be interceptable\n4. **Launch argument + app-side mock** - Similar pattern but at WebSocket layer\n\nAreas to test:\n- Relay connection failures\n- Relay disconnection during event fetch\n- Reconnection behavior after network recovery\n- Subscription handling during intermittent connectivity\n- Event publishing under poor network\n\nRelated:\n- damus-2qb: NetworkConditionSimulator for HTTP (completed)\n- damus-02i: Poor connectivity tests for all app flows","notes":"## Progress Update (2026-01-03)\n\n### Completed\n- ✅ WebSocketProtocol extracted for dependency injection\n- ✅ MockWebSocket created for unit testing\n- ✅ RelayConnectionTests: 19 unit tests for connection logic\n- ✅ RelayIntegrationTests: 8 NIP-01 protocol tests with strfry\n- ✅ CI workflow with sitespeedio/throttle for network simulation\n\n### Key Files Added\n- `damus/Core/Nostr/WebSocket.swift` - WebSocketProtocol\n- `damusTests/Mocking/MockWebSocket.swift` - comprehensive mock\n- `damusTests/RelayConnectionTests.swift` - unit tests\n- `damusTests/RelayIntegrationTests.swift` - integration tests\n- `.github/workflows/network-tests.yml` - CI with strfry + throttle\n\n### Remaining\nFeature-level tests tracked in separate beads (damus-02i children)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T15:02:47.772979-06:00","created_by":"e","updated_at":"2026-01-03T23:02:26.713247-06:00","closed_at":"2026-01-03T23:02:26.713247-06:00","close_reason":"Infrastructure complete: WebSocketProtocol, MockWebSocket, RelayConnectionTests (19), RelayIntegrationTests (8), RelayPoolMultiRelayTests (8), PostBoxTests (17). Feature-level tests tracked in separate beads (damus-uwn, damus-b6g, damus-0o9, damus-2zx).","labels":["automation","network testing","relay","websocket"]}
{"id":"damus-d5l","title":"Configure strfry relay for integration testing","description":"Set up strfry relay with permissive write policy for RelayIntegrationTests.\n\nCurrent state:\n- RelayIntegrationTests.swift expects local strfry relay on ws://localhost:7777\n- Default strfry image (dockurr/strfry) has restrictive write policy\n- Tests fail with 'blocked: pubkey not in whitelist'\n\nRequired configuration:\n- Start strfry with permissive write policy (allow all pubkeys)\n- OR use alternative relay image (nostr-rs-relay) with correct port mapping\n- Volume mount for persistent storage to avoid LMDB errors\n\nTest requirements:\n- Accept EVENT messages from any pubkey\n- Return OK responses\n- Support REQ/EOSE flow\n- Handle CLOSE messages\n\nOptions to implement:\n1. Custom strfry.conf with 'write' policy allowing all\n2. Use scsibug/nostr-rs-relay (port 8080 internal)\n3. Build custom relay Docker image for testing\n\nRelated:\n- RelayIntegrationTests.swift\n- .github/workflows/network-tests.yml\n- damus-02i (poor connectivity tests)\n- damus-czv (WebSocket testing)","notes":"Fixed by mounting permissive strfry-test.conf (writePolicy.plugin='') in CI. Created test/strfry-test.conf and updated .github/workflows/network-tests.yml to mount it.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:03:18.663108-06:00","created_by":"e","updated_at":"2026-01-05T17:20:27.643672-06:00","closed_at":"2026-01-05T17:15:55.58539-06:00","labels":["docker","integration","relay","testing"]}
{"id":"damus-deu","title":"MEDIUM: 5xx with NIP-96 error body returns non-retryable .serverError - should be retryable","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T17:22:49.033865-06:00","created_by":"e","updated_at":"2026-01-03T18:04:38.908446-06:00","closed_at":"2026-01-03T18:04:38.908446-06:00","close_reason":"fixed"}
{"id":"damus-eld","title":"Investigate: Relate WebSocket testing infrastructure to PR #3353 (Offline Indicator + Outbox)","description":"Investigate how the WebSocket testing infrastructure (Phase 1 \u0026 2) relates to PR #3353.\n\n## PR #3353 Summary: Offline Indicator + Outbox Upgrade\n\n**GitHub:** https://github.com/damus-io/damus/pull/3353\n**Status:** Open\n**Changes:** +1257 / -59 lines across 30 files\n\n### What It Adds\n1. **Offline indicator UI** - Pills in timeline, compose view showing offline state\n2. **Outbox queue** - PendingPostStore for drafts that send when back online\n3. **NWPathMonitor** - Reachability tracking in SignalModel\n4. **PostBox enhancements** - Retry logic, exponential backoff, stale cleanup\n5. **Auto-send on reconnect** - Pending posts flush when connectivity restored\n\n### Key Files Changed\n- `SignalModel.swift` - Added NWPathMonitor reachability tracking\n- `PostBox.swift` - Added pending post handling with retry caps\n- `PendingPostStore.swift` - **New** - Persistence for offline posts\n- `OutboxView.swift` - **New** - UI for pending posts queue\n\n---\n\n## Relationship to Our Testing Infrastructure\n\n### Direct Overlaps\n\n| Our Work | PR #3353 | Relationship |\n|----------|----------|--------------|\n| MockWebSocket | SignalModel connectivity | MockWebSocket can simulate offline→online transitions |\n| RelayConnectionTests (backoff) | PostBox retry/backoff | Same exponential backoff pattern, should align |\n| RelayIntegrationTests | Outbox flush on reconnect | Test that pending posts actually send |\n| sitespeedio/throttle CI | Offline testing | Throttle to 100% loss = offline simulation |\n\n### How MockWebSocket Helps Test PR #3353\n\n1. **Simulate offline state:**\n   ```swift\n   mockSocket.simulateDisconnect()\n   // Verify SignalModel.isOffline == true\n   // Verify offline pill appears\n   ```\n\n2. **Simulate reconnection:**\n   ```swift\n   mockSocket.simulateConnect()\n   // Verify pending posts flush\n   // Verify OK received for each\n   ```\n\n3. **Simulate partial connectivity:**\n   ```swift\n   // 2/5 relays connected\n   // Verify app shows 'online' (at least one relay works)\n   ```\n\n### Tests PR #3353 Already Added\n- `SignalModelTests.swift` - Reachability logic\n- `PendingPostStoreTests.swift` - Persistence, trimming\n- `OfflineIndicatorLogicTests.swift` - UI pill logic\n- `damusUITests.swift` - Offline indicator in composer\n\n### Gap: Missing Integration Tests\nPR #3353 tests individual components but lacks:\n- End-to-end offline→post→reconnect→verify published test\n- Multi-relay partial failure scenarios\n- Race condition: reconnect during flush\n\n---\n\n## Recommendations\n\n### 1. Align Backoff Constants\nPR #3353 adds retry caps and backoff in PostBox. Compare with RelayConnection backoff:\n- RelayConnection: `backoff *= 2.0` starting at 1.0s\n- PostBox: Check if aligned or conflicts\n\n### 2. Add Integration Test for Outbox Flush\nUsing our infrastructure:\n```swift\nfunc testOutboxFlushesOnReconnect() async {\n    // 1. Start offline (all MockWebSockets disconnected)\n    // 2. Create pending post via PostBox\n    // 3. Simulate reconnect\n    // 4. Verify EVENT sent and OK received\n    // 5. Verify post removed from PendingPostStore\n}\n```\n\n### 3. Test SignalModel with MockWebSocket\nSignalModel uses NWPathMonitor + relay count. Test:\n- Zero relays configured = offline\n- All relays disconnected = offline  \n- One relay connected = online\n\n### 4. CI Workflow Enhancement\nAdd offline simulation to network-tests.yml:\n```yaml\n- name: Test offline mode\n  run: |\n    sudo throttle --profile 100loss\n    # Run outbox tests\n    sudo throttle --stop\n```\n\n---\n\n## Action Items\n- [ ] Review PR #3353 backoff logic vs RelayConnection backoff\n- [ ] Add OutboxIntegrationTests using MockWebSocket\n- [ ] Ensure SignalModel tests use MockWebSocket for relay state\n- [ ] Consider contributing tests back to PR #3353","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:04:44.948544-06:00","created_by":"e","updated_at":"2026-01-03T22:05:16.447765-06:00","labels":["investigation","offline","testing"]}
{"id":"damus-ewa","title":"MEDIUM: Retry logic should not retry 4xx HTTP errors - map to non-retryable UploadError, keep 5xx retryable","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T17:01:11.623726-06:00","created_by":"e","updated_at":"2026-01-03T17:04:18.143153-06:00","closed_at":"2026-01-03T17:04:18.143153-06:00","close_reason":"Added httpError case and 4xx status code check"}
{"id":"damus-f5k","title":"Add debug logging for image upload pipeline","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:45:05.078621-06:00","created_by":"e","updated_at":"2026-01-03T13:00:58.944307-06:00","closed_at":"2026-01-03T13:00:58.944307-06:00","close_reason":"Closed","labels":["debugging","enhancement","media"],"dependencies":[{"issue_id":"damus-f5k","depends_on_id":"damus-0pj","type":"parent-child","created_at":"2026-01-03T12:47:07.211686-06:00","created_by":"daemon"}],"comments":[{"id":5,"issue_id":"damus-f5k","author":"e","text":"Add structured logging throughout upload pipeline to aid debugging:\n\n1. Log raw server response when upload fails\n2. Log security scoped resource access success/failure\n3. Log image processing steps and failures\n4. Log file sizes, mime types, URLs\n\nUse existing Log utility with .image_uploading category.\n\nFiles: AttachMediaUtility.swift, MediaUploader.swift, MediaPicker.swift, ImageProcessing.swift","created_at":"2026-01-03T18:45:31Z"},{"id":6,"issue_id":"damus-f5k","author":"e","text":"## Implementation Complete\n\n### Logging added to 3 files:\n\n**1. AttachMediaUtility.swift**\n- Upload start: type, mime, API URL\n- NIP-98 auth header addition\n- File read errors\n- File size (KB/MB)\n- HTTP response status and size\n- Success URL or failure reason\n- Network errors\n\n**2. MediaUploader.swift**\n- Raw response body (first 500 chars)\n- Response status\n- JSON parsing errors\n- Server error messages\n- Missing URL tag errors\n\n**3. MediaPicker.swift**\n- Selection count\n- Image/video loading errors\n- GIF processing\n- Security scoped resource access/denial\n- Fallback processing success/failure\n- Processing completion count\n\n### Log Category\nAll logs use `.image_uploading` category for filtering in Console.app\n\n### Example log output:\n```\n[image_uploading] Starting upload: type=image, mime=image/jpg, api=https://nostr.build/...\n[image_uploading] Media file size: 1234.56 KB (1.21 MB)\n[image_uploading] Upload response: HTTP 200, size=456 bytes\n[image_uploading] Upload successful: https://nostr.build/...\n```\n\nOr on failure:\n```\n[image_uploading] Upload response: HTTP 413, size=89 bytes\n[image_uploading] Server returned error: File size exceeds limit\n[image_uploading] Upload failed: File size exceeds limit\n```","created_at":"2026-01-03T19:00:54Z"}]}
{"id":"damus-fsj","title":"HIGH: Fix potential crash in NetworkConditionSimulator timeout closure - weak self force unwrap after 2s delay can crash if deallocated","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:01:11.512368-06:00","created_by":"e","updated_at":"2026-01-03T17:04:18.119222-06:00","closed_at":"2026-01-03T17:04:18.119222-06:00","close_reason":"Fixed with guard let self = self else { return }"}
{"id":"damus-hoz","title":"User Lookup: Add poor network testing for profile fetching","description":"Add network tests for fetching user profiles when resolving mentions, displaying avatars, or loading profile views under poor network conditions. Test caching behavior and fallbacks.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T15:52:00.789263-06:00","created_by":"e","updated_at":"2026-01-05T16:12:11.017926-06:00","closed_at":"2026-01-05T16:12:11.017928-06:00","labels":["network","profiles","testing"]}
{"id":"damus-hw6","title":"Notifications: Add poor network testing for notification event loading","description":"Add network tests for loading notification events (mentions, reactions, zaps, reposts) under poor network conditions. Test timeout handling, partial results, and recovery.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T15:52:00.210763-06:00","created_by":"e","updated_at":"2026-01-05T16:12:10.932866-06:00","closed_at":"2026-01-05T16:12:10.932881-06:00","labels":["network","notifications","testing"]}
{"id":"damus-hxj","title":"Muting: Add poor network testing for mute list publishing","description":"Add network tests for mute list operations under poor network conditions. Test mute list event publishing and ensure mutes are properly synced across relays.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T15:52:00.910679-06:00","created_by":"e","updated_at":"2026-01-05T16:04:29.442563-06:00","closed_at":"2026-01-05T16:04:29.442567-06:00","labels":["muting","network","testing"]}
{"id":"damus-k5j","title":"Add poor/intermittent network connectivity testing for image uploads","notes":"Added MockURLProtocol, RetryTestURLProtocol, 18 unit tests for retry logic, and Network Link Conditioner documentation","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:44:27.819548-06:00","created_by":"e","updated_at":"2026-01-03T14:30:10.699445-06:00","closed_at":"2026-01-03T14:30:10.699448-06:00","labels":["media","network","testing"],"dependencies":[{"issue_id":"damus-k5j","depends_on_id":"damus-0pj","type":"parent-child","created_at":"2026-01-03T12:47:07.21328-06:00","created_by":"daemon"}],"comments":[{"id":7,"issue_id":"damus-k5j","author":"e","text":"Testing scenarios needed:\n- Slow upload (throttled bandwidth)\n- Intermittent drops mid-upload\n- High latency connections  \n- Timeout scenarios\n- Connection loss during multipart upload\n- Retry behavior on transient failures\n\nContext: Issue #2198 specifically mentions 'poor internet connection' causing upload errors. Current code has no retry logic and relies on URLSession defaults for timeouts.\n\nRelated GitHub issues: #3484, #2198, #1286","created_at":"2026-01-03T18:44:35Z"}]}
{"id":"damus-n3q","title":"Squash PR commits into logically distinct structure per damus guidelines","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T17:37:18.995347-06:00","created_by":"e","updated_at":"2026-01-03T18:04:33.758361-06:00","closed_at":"2026-01-03T18:04:33.758361-06:00","close_reason":"fixed"}
{"id":"damus-r77","title":"Investigate iOS 18 security scoped resource and CGImageSource compatibility","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:45:04.987609-06:00","created_by":"e","updated_at":"2026-01-03T14:15:53.176254-06:00","closed_at":"2026-01-03T14:15:53.176257-06:00","labels":["bug","ios18","media"],"dependencies":[{"issue_id":"damus-r77","depends_on_id":"damus-63x","type":"relates-to","created_at":"2026-01-03T12:45:45.345098-06:00","created_by":"daemon"},{"issue_id":"damus-r77","depends_on_id":"damus-0pj","type":"parent-child","created_at":"2026-01-03T12:47:07.210882-06:00","created_by":"daemon"}],"comments":[{"id":8,"issue_id":"damus-r77","author":"e","text":"GitHub issue #3484 reports failures on iOS 18.7 specifically. Potential iOS 18 breaking changes:\n\n1. startAccessingSecurityScopedResource() behavior (MediaPicker.swift:136)\n2. CGImageSourceCreateWithData/URL operations (ImageProcessing.swift)\n3. PHPickerViewController changes\n4. Stricter sandboxing for temp file access\n\nNeed to test on iOS 18 device and check Apple release notes for breaking changes.\n\nFiles: MediaPicker.swift, ImageProcessing.swift","created_at":"2026-01-03T18:45:31Z"},{"id":9,"issue_id":"damus-r77","author":"e","text":"## iOS 18 Investigation Findings\n\n### Key Issue Found: CGImageDestinationAddImageFromSource Bug\n\nThe codebase uses `CGImageDestinationAddImageFromSource` in `ImageProcessing.swift:147` which has known issues in iOS 18/macOS 15.\n\n**Symptoms reported by developers:**\n- Console errors: `bad image size (0 x 0)`\n- `CGImageSourceCreateThumbnailAtIndex - 'HJPG' - failed to create thumbnail [-67]`\n- Crashes in `CGImageDestinationFinalize`\n- HEIC images from iOS 18 devices have 'corrupt header' issues\n\n**Root cause:** iOS 18 changes to Image I/O framework affecting HEIC/JPEG transcoding and thumbnail generation.\n\n**Files affected in damus:**\n- `ImageProcessing.swift` - uses `CGImageDestinationAddImageFromSource` (line 147)\n- `MediaPicker.swift` - uses `startAccessingSecurityScopedResource` (line 214)\n\n**Known workaround:** Use `CGImageSourceCreateImageAtIndex` + `CGImageSourceCopyPropertiesAtIndex` + `CGImageDestinationAddImage` instead of `CGImageDestinationAddImageFromSource`\n\n### Sources\n- Apple Developer Forums thread 769659\n- Apple Developer Forums thread 768446  \n- Immich GitHub issue #10464","created_at":"2026-01-03T20:04:45Z"},{"id":10,"issue_id":"damus-r77","author":"e","text":"## Recommendations\n\n### Immediate Fix: Replace CGImageDestinationAddImageFromSource\n\nIn `ImageProcessing.swift`, replace the problematic API call with the workaround:\n\n**Current code (line 146-148):**\n```swift\nfor i in 0..\u003ctotalCount {\n    CGImageDestinationAddImageFromSource(destination, source, i, removeGPSProperties)\n}\n```\n\n**Recommended fix:**\n```swift\nfor i in 0..\u003ctotalCount {\n    guard let image = CGImageSourceCreateImageAtIndex(source, i, nil),\n          let properties = CGImageSourceCopyPropertiesAtIndex(source, i, nil) else {\n        continue\n    }\n    // Merge GPS removal with existing properties\n    let mutableProps = NSMutableDictionary(dictionary: properties)\n    mutableProps[kCGImagePropertyGPSDictionary] = kCFNull\n    CGImageDestinationAddImage(destination, image, mutableProps as CFDictionary)\n}\n```\n\n### Why This Helps\n1. Avoids the iOS 18 bug in `CGImageDestinationAddImageFromSource`\n2. Explicit image/properties extraction is more reliable\n3. Works across iOS 17 and iOS 18\n\n### Additional Considerations\n1. **HEIC from camera**: CameraService.swift captures HEVC/HEIF - these images go through the same processing path\n2. **Error handling**: Current code silently returns nil on failure - the new debug logging will help diagnose\n3. **Testing needed**: Test with HEIC images from iOS 18 devices specifically","created_at":"2026-01-03T20:05:45Z"},{"id":11,"issue_id":"damus-r77","author":"e","text":"## Resolution\n\nFixed in commit 4ffdb38a - 'Fix iOS 18 image processing crash with HEIC images'\n\nThe fix replaces the problematic `CGImageDestinationAddImageFromSource` API with explicit image extraction using `CGImageSourceCreateImageAtIndex` + `CGImageDestinationAddImage`.","created_at":"2026-01-03T20:15:58Z"}]}
{"id":"damus-rbn","title":"Add retry logic for transient upload failures","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:45:05.172501-06:00","created_by":"e","updated_at":"2026-01-03T13:07:51.015763-06:00","closed_at":"2026-01-03T13:07:51.015763-06:00","close_reason":"Closed","labels":["enhancement","media","network"],"dependencies":[{"issue_id":"damus-rbn","depends_on_id":"damus-0pj","type":"parent-child","created_at":"2026-01-03T12:47:07.212451-06:00","created_by":"daemon"}],"comments":[{"id":12,"issue_id":"damus-rbn","author":"e","text":"Current upload code has no retry logic - any transient failure shows error immediately.\n\nAdd:\n- Configurable retry count (e.g., 3 attempts)\n- Exponential backoff between retries\n- Only retry on transient errors (network timeout, 5xx responses)\n- Don't retry on permanent errors (4xx, file too large)\n\nFiles: ImageUploadModel.swift, AttachMediaUtility.swift","created_at":"2026-01-03T18:45:31Z"},{"id":13,"issue_id":"damus-rbn","author":"e","text":"Analysis of current network interruption behavior:\n\n**What happens when connection drops mid-upload:**\n- 1 second drop: TCP connection might survive (unlikely). Usually fails with NSURLErrorNetworkConnectionLost\n- 10 second drop: Connection dead. Fails immediately with network error.\n\n**Current code has NO retry logic:**\n- URLSession.shared.data() is called once\n- Any failure immediately returns .failed(error)\n- User must manually retry\n\n**Recommended implementation:**\n- Wrap upload in retry loop (3 attempts)\n- Use exponential backoff: 1s, 2s, 4s delays\n- Only retry on transient errors:\n  - NSURLErrorNetworkConnectionLost\n  - NSURLErrorTimedOut  \n  - NSURLErrorNotConnectedToInternet (if reconnects)\n  - HTTP 5xx responses\n- Don't retry on:\n  - HTTP 4xx (client error)\n  - File read errors\n  - Server error responses (file too large, etc)\n\n**Consider:** iOS background URLSession for large uploads that survive app backgrounding","created_at":"2026-01-03T18:50:38Z"},{"id":14,"issue_id":"damus-rbn","author":"e","text":"## Implementation Complete\n\n### Changes Made:\n\n**1. MediaUploader.swift - Added `isRetryable` property to UploadError**\nRetryable errors:\n- `NSURLErrorTimedOut`\n- `NSURLErrorCannotConnectToHost`\n- `NSURLErrorNetworkConnectionLost`\n- `NSURLErrorNotConnectedToInternet`\n- `NSURLErrorDNSLookupFailed`\n- `jsonParsingFailed` (could be transient server issue)\n- `missingURL` (could be transient)\n\nNon-retryable:\n- `serverError` (explicit rejection like \"file too large\")\n- `fileReadError` (local file issue)\n- `invalidAPIURL` (configuration issue)\n- `noMediaData` (local issue)\n\n**2. AttachMediaUtility.swift - Added retry logic**\n- Added `UploadRetryConfig` struct with `maxRetries` and `baseDelaySeconds`\n- Default: 2 retries with 1s base delay (1s, 2s exponential backoff)\n- Added `executeWithRetry()` method that wraps single upload attempts\n- Added `executeSingleUpload()` for single attempt logic\n- Logs retry attempts and final outcome\n\n### Behavior:\n- First attempt fails with network timeout\n- Wait 1 second, retry\n- Second attempt fails with connection lost  \n- Wait 2 seconds, retry\n- Third attempt succeeds or fails permanently\n\n### Backwards Compatible:\n- `retryConfig` parameter has default value\n- Existing callers continue to work unchanged\n- Can pass `UploadRetryConfig.none` to disable retries","created_at":"2026-01-03T19:07:46Z"}]}
{"id":"damus-rrq","title":"Posting Notes: Add poor network testing for event publishing","description":"Add automated tests for note posting under poor network conditions.\n\n## Context\nUsers report 'Posted' feedback but notes never appear. Need to verify:\n1. EVENT sent to relay\n2. OK response received (or timeout handled)\n3. UI reflects actual publish state\n\n## Test Scenarios\n- Post succeeds under 3G conditions\n- Post shows pending state during slow network\n- Post fails gracefully when relay unreachable\n- Retry behavior after transient failure\n- OK message with 'duplicate:' prefix handling\n- OK message with 'rate-limited:' prefix handling\n- Timeout when no OK received within X seconds\n- Multi-relay publish (some succeed, some fail)\n\n## NIP-01 Messages\n- Client sends: [\\EVENT\\, \u003cevent\u003e]\n- Relay responds: [\\OK\\, \u003cevent_id\u003e, true/false, \u003cmessage\u003e]\n\n## Files to Test\n- `damus/Features/Posting/Models/PostingModel.swift` (or equivalent)\n- `damus/Features/Posting/Views/PostView.swift`\n\n## Approach\n1. Use MockWebSocket to simulate delayed/failed OK responses\n2. Verify UI state: composing → sending → sent/failed\n3. Test with strfry for integration tests","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:00:50.847903-06:00","created_by":"e","updated_at":"2026-01-03T22:58:32.389989-06:00","closed_at":"2026-01-03T22:58:32.389989-06:00","close_reason":"Added 17 PostBox tests covering event queuing, OK response handling, multi-relay coordination, on_flush callbacks, delayed send, and retry logic. Commit: 2c655f93","labels":["network","posting","testing"]}
{"id":"damus-tah","title":"Fix error message truncation on small screens in PostView","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:45:04.81935-06:00","created_by":"e","updated_at":"2026-01-03T12:57:49.842567-06:00","closed_at":"2026-01-03T12:57:49.842567-06:00","close_reason":"Closed","labels":["bug","media","ui"],"dependencies":[{"issue_id":"damus-tah","depends_on_id":"damus-63x","type":"relates-to","created_at":"2026-01-03T12:45:45.300088-06:00","created_by":"daemon"},{"issue_id":"damus-tah","depends_on_id":"damus-0pj","type":"parent-child","created_at":"2026-01-03T12:47:07.209162-06:00","created_by":"daemon"}],"comments":[{"id":15,"issue_id":"damus-tah","author":"e","text":"GitHub issue #2198 reports error messages are cut off on small phone screens when upload fails on poor connections.\n\nFix: In PostView.swift error display, allow multiline text:\n- Add .lineLimit(nil)\n- Add .fixedSize(horizontal: false, vertical: true)\n\nFiles: PostView.swift (around line 323-326)","created_at":"2026-01-03T18:45:31Z"},{"id":16,"issue_id":"damus-tah","author":"e","text":"## Implementation Complete\n\n### Changes Made:\n\n**1. PostView.swift (line 323-330)**\nError text now has:\n- `.font(.caption)` - smaller font to fit more text\n- `.lineLimit(3)` - allow up to 3 lines\n- `.minimumScaleFactor(0.8)` - scale down if needed\n- `.fixedSize(horizontal: false, vertical: true)` - prevent horizontal truncation\n\n**2. EditPictureControl.swift (line 109-125)**\nError sheet redesigned:\n- Added \"Upload Failed\" header\n- Error message with `.multilineTextAlignment(.center)`\n- `.fixedSize(horizontal: false, vertical: true)` for full message\n- Added \"OK\" dismiss button\n- Set `.presentationDetents([.height(200)])` for consistent height\n\n### Before vs After:\n\n**PostView Before:** Single line, truncated on small screens\n**PostView After:** Up to 3 lines, scales to fit\n\n**EditPictureControl Before:** Plain text, no formatting\n**EditPictureControl After:** Proper error dialog with title, message, and button","created_at":"2026-01-03T18:57:45Z"}]}
{"id":"damus-uwn","title":"DMs (NIP-04/44): Add poor network testing for encrypted message delivery","description":"Add automated tests for DM sending/receiving under poor network conditions.\n\n## Context\nDMs use NIP-04 (deprecated) or NIP-44 encryption. Messages sent but not delivered is critical failure.\n\n## Test Scenarios\n- DM sends successfully under 3G\n- DM shows pending state during slow network\n- DM retry after transient failure\n- DM receives while reconnecting\n- Conversation loads with partial connectivity\n- Encryption/decryption doesn't timeout on slow CPU\n- Multiple DM threads loading concurrently\n\n## NIP-04/44 Considerations\n- Encrypted content in 'content' field\n- Kind 4 (NIP-04) or Kind 1059 (NIP-44 gift wrap)\n- Must test both send and receive paths\n\n## Files to Test\n- `damus/Features/DM/` directory\n- DM-related models and views\n\n## Approach\n1. MockWebSocket for unit tests\n2. strfry + throttle for integration\n3. Verify message appears in conversation after send\n4. Verify incoming messages during reconnection","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:00:51.010063-06:00","created_by":"e","updated_at":"2026-01-05T15:58:21.877666-06:00","closed_at":"2026-01-05T15:58:21.877667-06:00","labels":["dms","network","testing"]}
{"id":"damus-uya","title":"Add error handling for Stage 1 media selection/processing failures","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:45:04.897233-06:00","created_by":"e","updated_at":"2026-01-03T13:05:01.793226-06:00","closed_at":"2026-01-03T13:05:01.793226-06:00","close_reason":"Closed","labels":["bug","error-handling","media"],"dependencies":[{"issue_id":"damus-uya","depends_on_id":"damus-63x","type":"relates-to","created_at":"2026-01-03T12:45:45.323086-06:00","created_by":"daemon"},{"issue_id":"damus-uya","depends_on_id":"damus-0pj","type":"parent-child","created_at":"2026-01-03T12:47:07.210061-06:00","created_by":"daemon"}],"comments":[{"id":17,"issue_id":"damus-uya","author":"e","text":"In MediaPicker.swift and ImageProcessing.swift, multiple failure points silently return without notifying user:\n- guard let url = item as? URL else { return } (line 61)\n- guard let newUrl = fallback(url) else { return } (line 142)\n- guard let imageData = try? Data(contentsOf: url) else { return nil } (ImageProcessing.swift:13)\n\nUser gets no feedback when media selection/processing fails - image just doesn't appear.\n\nFix: Add error callbacks or state to surface these failures to UI.\n\nFiles: MediaPicker.swift, ImageProcessing.swift, PostView.swift","created_at":"2026-01-03T18:45:31Z"},{"id":18,"issue_id":"damus-uya","author":"e","text":"## Implementation Complete\n\n### Changes Made:\n\n**1. MediaPicker.swift**\n- Added `MediaPickerError` struct for error info\n- Added `onError: ((Int) -\u003e Void)?` callback parameter\n- Added `failedCount` tracking in Coordinator  \n- Added `recordFailure()` helper method\n- All failure points now call `recordFailure()` instead of just `dispatchGroup.leave()`\n- `dispatchGroup.notify` now calls `onError` with failure count if any failures occurred\n\n**2. PostView.swift**\n- Added `onError` callback to MediaPicker\n- Shows localized error message: \"Failed to process N items\"\n- Uses existing `error` state to display message\n\n**3. EditPictureControl.swift**\n- Added `onError` callback to MediaPicker  \n- Shows \"Failed to process the selected image\" via existing `failed()` method\n\n### User Experience:\n\n**Before:** Media silently didn't appear when processing failed\n**After:** User sees \"Failed to process 2 items\" (or similar) in red text\n\n### Backwards Compatible:\n`onError` callback is optional - existing code continues to work without changes.","created_at":"2026-01-03T19:04:55Z"}]}
{"id":"damus-v9o","title":"Create PR for relay integration tests and network condition testing infrastructure","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-06T03:08:44.977613-06:00","created_by":"e","updated_at":"2026-01-06T03:08:44.977613-06:00","labels":["network","pr","relay","testing"]}
{"id":"damus-w2w","title":"LOW: Commit 61a4ff34 mixes .gitignore edit with crash fix - violates one logical change per commit","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-03T17:22:49.127193-06:00","created_by":"e","updated_at":"2026-01-03T18:04:38.935403-06:00","closed_at":"2026-01-03T18:04:38.935403-06:00","close_reason":"fixed"}
{"id":"damus-xtm","title":"Bookmarks: Add poor network testing for bookmark list sync","description":"Add network tests for bookmark list operations under poor network conditions. Test bookmark event publishing and retrieval when connections are unstable.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T15:52:01.068405-06:00","created_by":"e","updated_at":"2026-01-05T16:04:29.46796-06:00","closed_at":"2026-01-05T16:04:29.467963-06:00","labels":["bookmarks","network","testing"]}
