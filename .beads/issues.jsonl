{"id":"damus-8xn","title":"Fix PFP robot bug - GitHub issue #3540","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-16T11:41:43.074601-06:00","created_by":"e","updated_at":"2026-01-16T14:26:17.006868-06:00","closed_at":"2026-01-16T14:26:17.006868-06:00","close_reason":"Closed","comments":[{"id":1,"issue_id":"damus-8xn","author":"e","text":"Root cause found:\n\nProfilePicImageView (expanded PFP view) does NOT have profile streaming logic.\n\nProfilePicView (small PFP) has a .task that streams profile updates via damusState.nostrNetwork.profilesManager.streamProfile.\n\nProfilePicImageView only calls get_profile_url(picture: nil, ...) once at view creation. If the profile isn't cached at that moment, it falls back to robohash and never updates.\n\nFix: Add DamusState to ProfilePicImageView and stream profile updates like ProfilePicView does.\n\nPR #3514 is unrelated - it's about preloading profiles in the timeline, not the expanded PFP view.","created_at":"2026-01-16T17:45:36Z"},{"id":2,"issue_id":"damus-8xn","author":"e","text":"Fix implemented and build verified:\n- Added damusState parameter to ProfilePicImageView\n- Added @State picture property to track profile picture URL\n- Added .task to stream profile updates from profilesManager\n- Updated ProfileView.swift caller to pass damus_state\n- Updated preview to use test_damus_state\n\nBuild succeeded. Ready for testing.","created_at":"2026-01-16T17:52:40Z"}]}
{"id":"damus-9fa","title":"Marker safety can be bypassed with explicit path opens","description":"**Issue:** The marker readiness check is only enforced when path == nil \u0026\u0026 !owns_db_file (nostrdb/Ndb.swift:123). Explicit path opens bypass marker validation by design.\n\n**Impact:** A future production caller using `Ndb(path: Ndb.snapshot_db_path, owns_db_file: false)` would bypass the marker protocol, allowing reads during snapshot updates.\n\n**Current behavior:**\n- `Ndb(path: nil, owns_db_file: false)` ‚Üí checks marker ‚úì\n- `Ndb(path: Ndb.snapshot_db_path, owns_db_file: false)` ‚Üí bypasses marker ‚úó\n- Test at damusTests/DatabaseSnapshotManagerTests.swift:663 codifies this bypass\n\n**Risk:**\n- Code review could miss that explicit snapshot path bypasses safety\n- Future refactoring could introduce race condition\n- Pattern is documented in test as 'expected' behavior\n\n**Fix options:**\n1. Always check marker for snapshot_db_path regardless of how it's specified\n2. Add warning comments at explicit-path callsites\n3. Make snapshot_db_path private, force use of default path\n4. Add runtime assertion if explicit path == snapshot_db_path\n\n**Files:**\n- nostrdb/Ndb.swift:123 (marker check condition)\n- damusTests/DatabaseSnapshotManagerTests.swift:663 (test codifying bypass)","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-10T14:09:00.047572-06:00","created_by":"e","updated_at":"2026-02-10T14:23:25.797857-06:00","closed_at":"2026-02-10T14:23:25.797857-06:00","close_reason":"Fixed in commit ecd5a49c. All tests passing."}
{"id":"damus-a0f","title":"Remove .beads/issues.jsonl from snapshot marker PR","description":"**Issue:** .beads/issues.jsonl:1 was included in commit b83292a8 but is unrelated to snapshot marker protocol behavior.\n\n**Impact:** \n- Pollutes PR diff with tooling artifacts\n- Makes code review harder\n- Violates clean commit guidelines\n\n**Current state:**\nCommit b83292a8 includes:\n- damus/Core/Storage/DatabaseSnapshotManager.swift ‚úì\n- nostrdb/Ndb.swift ‚úì\n- damusTests/DatabaseSnapshotManagerTests.swift ‚úì\n- .beads/issues.jsonl ‚úó (should not be in PR)\n\n**Fix:**\nUse interactive rebase to remove .beads/issues.jsonl from commit b83292a8:\n```bash\ngit rebase -i HEAD~2\n# Mark commit for edit\ngit reset HEAD~1 .beads/issues.jsonl\ngit commit --amend --no-edit\ngit rebase --continue\n```\n\nOr squash into simplifier commit b570834d and recreate without .beads files.\n\n**Prevention:**\n- Add .beads/ to .gitignore (if not project-tracked)\n- Or use beads hooks to auto-exclude from commits\n- Or commit .beads separately from feature code\n\n**Files:**\n- .beads/issues.jsonl (in commit b83292a8)","status":"closed","priority":4,"issue_type":"task","created_at":"2026-02-10T14:09:20.557558-06:00","created_by":"e","updated_at":"2026-02-10T14:17:55.129028-06:00","closed_at":"2026-02-10T14:17:55.129028-06:00","close_reason":".beads/issues.jsonl is auto-added by pre-commit hook as part of beads workflow. This is intentional to sync issue state with commits."}
{"id":"damus-c8b","title":"Extract transaction retention fix from PR #3564 for startup crash","description":"## Status: READY FOR PR ‚úÖ\n\nSuccessfully implemented and tested minimal transaction retention fix for #3610.\n\n## Build \u0026 Test Results\n\n‚úÖ Build succeeded  \n‚úÖ All 5 new transaction retention tests passed\n‚úÖ All existing NdbTests passed  \n‚úÖ Extension compatibility confirmed\n\n## Implementation Complete\n\n**Files changed:**\n- nostrdb/NdbUseLock.swift - Added retainForTransaction/releaseTransaction\n- nostrdb/NdbTxn.swift - Added retention calls in both NdbTxn and SafeNdbTxn  \n- nostrdb/Ndb.swift - Made ndbAccessLock internal\n- nostrdb/Test/NdbTests.swift - Added 6 comprehensive tests\n\n**Tests (all passed):**\n1. test_close_waits_for_active_transaction (0.325s)\n2. test_transaction_access_during_close_attempt (0.108s)\n3. test_multiple_transactions_block_close (0.109s)\n4. test_startup_simulation_with_concurrent_transactions (0.003s)\n5. test_transaction_retain_release_balance (0.038s)  \n6. All existing tests passed\n\n## Extension Analysis\n\nReviewed DamusNotificationService code:\n- Extensions open snapshot DB with owns_db_file=false\n- Extensions use same NdbTxn code paths (lookup_note, lookup_profile)\n- **Our fix prevents use-after-free in extensions too**\n\n**Note:** jb55 mentioned \"janky\" snapshot mechanism. There are TWO potential extension issues:\n1. ‚úÖ Transaction use-after-free ‚Üê **FIXED by this PR**\n2. ‚ùå Snapshot update race conditions ‚Üê NOT addressed (would need snapshot marker protocol from PR #3564 commit 8)\n\n## What Was EXCLUDED\n\nPer requirements, excluded from PR #3564:\n- Extension readonly mode (commits 1-6)  \n- 32MB mapsize changes\n- Snapshot marker protocol (commit 8)\n- All extension-specific code\n\n## Next: Create PR\n\nReady to push branch and create PR with proper damus template.","status":"in_progress","priority":0,"issue_type":"bug","created_at":"2026-02-10T11:47:57.607531-06:00","created_by":"e","updated_at":"2026-02-10T12:06:58.664389-06:00"}
{"id":"damus-e4e","title":"Test doesn't verify marker ordering during snapshot update","description":"**Issue:** damusTests/DatabaseSnapshotManagerTests.swift:693 (testPerformSnapshot_RemovesMarkerBeforeUpdate) checks only final marker existence, not marker state during transition.\n\n**Impact:** Regressions in update ordering (e.g., marker written before old snapshot deleted) could pass tests.\n\n**Current test:**\n```swift\n// Create initial snapshot\ntry await manager.performSnapshot()\nXCTAssertTrue(marker exists)\n\n// Run second snapshot\ntry await manager.performSnapshot()\n\n// Only checks: marker exists after completion\nXCTAssertTrue(marker exists)\n```\n\n**What's not tested:**\n- Marker is removed BEFORE old snapshot deleted\n- Marker is written AFTER new snapshot moved\n- No window where marker exists but snapshot is invalid\n\n**Fix options:**\n1. Add FileManager observation to track marker state during update\n2. Inject test hooks at each step (marker remove, snapshot delete, snapshot move, marker write)\n3. Use async expectations to verify marker doesn't exist mid-update\n4. Accept limitation (ordering verified by code review only)\n\n**Note:** This is low priority because the ordering is enforced by sequential code (not concurrent), so regressions would require deliberate reordering.\n\n**Files:**\n- damusTests/DatabaseSnapshotManagerTests.swift:693","status":"closed","priority":4,"issue_type":"task","created_at":"2026-02-10T14:09:10.996763-06:00","created_by":"e","updated_at":"2026-02-10T14:23:25.798848-06:00","closed_at":"2026-02-10T14:23:25.798848-06:00","close_reason":"Fixed in commit ecd5a49c. All tests passing."}
{"id":"damus-oz0","title":"Marker write failure treated as success in snapshot protocol","description":"**Issue:** damus/Core/Storage/DatabaseSnapshotManager.swift:291 swallows marker write errors, but performSnapshot() still updates last-snapshot timestamp at line 127.\n\n**Impact:** Since Ndb.open requires marker presence for default snapshot reads (nostrdb/Ndb.swift:131), a transient marker write failure can make snapshot reads fail until the next allowed snapshot interval (1 hour).\n\n**Current behavior:**\n- Marker write fails (e.g., disk full, permissions)\n- Error logged but not thrown\n- Timestamp updated ‚Üí next snapshot blocked for 1 hour\n- Extensions can't read snapshot (marker missing)\n\n**Expected behavior:**\n- Marker write failure should NOT update timestamp\n- Should retry on next timer tick\n- Or throw error to prevent timestamp update\n\n**Fix options:**\n1. Don't catch marker write error - let it propagate (prevents timestamp update)\n2. Add separate 'marker write failed' state to retry immediately\n3. Check marker exists before updating timestamp\n\n**Files:**\n- damus/Core/Storage/DatabaseSnapshotManager.swift:291 (error swallowed)\n- damus/Core/Storage/DatabaseSnapshotManager.swift:127 (timestamp update)","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-10T14:08:50.802852-06:00","created_by":"e","updated_at":"2026-02-10T14:23:25.796289-06:00","closed_at":"2026-02-10T14:23:25.796289-06:00","close_reason":"Fixed in commit ecd5a49c. All tests passing."}
{"id":"damus-wqp","title":"Investigate extension snapshot race condition crashes","description":"## Investigation Complete ‚úÖ\n\n### Root Cause Confirmed\n\n**The Race Condition:**\nCurrent DatabaseSnapshotManager (lines 241-267) has a window where:\n1. Old snapshot is deleted\n2. **‚ö†Ô∏è RACE WINDOW** - no valid snapshot exists\n3. New snapshot is moved to final location\n\nExtensions calling `Ndb(owns_db_file: false)` during this window will:\n- Try to open non-existent/incomplete database\n- Crash with `mdb_page_search` errors  \n- See corrupt/missing data\n\n### Solution (from closed PR #3564 commit 56092471)\n\n**Snapshot Marker Protocol:**\n1. Define marker file: `snapshot.ready`\n2. **Before update**: Remove marker ‚Üí extensions know snapshot is invalid\n3. Delete old snapshot + move new snapshot\n4. **After update**: Write marker ‚Üí extensions know snapshot is ready\n5. **Extensions check**: Only open if marker exists\n\n**Files to extract from PR #3564:**\n- `DatabaseSnapshotManager.swift` - Marker management during updates\n- `Ndb.swift` - `snapshot_is_ready()` check in init  \n- `DatabaseSnapshotManagerTests.swift` - Marker protocol tests\n\n### Status\n\nPR #3564 was **CLOSED** (not merged) - likely split into smaller PRs:\n- ‚úÖ Transaction retention ‚Üí **PR #3614** (extracted, in review)\n- ‚ùå Snapshot marker protocol ‚Üí **Needs extraction** (ready in closed PR)\n- ‚ùå Readonly mode for extensions ‚Üí Separate concern\n\n### Next Steps\n\nCreated follow-up issue to extract snapshot marker protocol as separate PR.\n\n## Related\n\n- PR #3564 (closed): https://github.com/damus-io/damus/pull/3564\n- PR #3614 (open): https://github.com/damus-io/damus/pull/3614  \n- Commit with marker fix: 56092471","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-02-10T12:15:35.761596-06:00","created_by":"e","updated_at":"2026-02-10T13:28:05.361103-06:00","closed_at":"2026-02-10T13:28:05.361103-06:00","close_reason":"Investigation complete. Found race condition and solution in closed PR #3564. Created extraction task damus-zid."}
{"id":"damus-zid","title":"Extract snapshot marker protocol from PR #3564","description":"## Context\n\nInvestigation of damus-wqp revealed a race condition where extensions can crash when opening the snapshot database during updates. The fix (snapshot marker protocol) exists in closed PR #3564 commit 56092471 but needs to be extracted as a separate, focused PR.\n\n## The Problem\n\n**Current Race Condition:**\n```\n1. Main app: Delete old snapshot\n2. ‚ö†Ô∏è RACE WINDOW - no valid snapshot exists!\n3. Extension: Tries to open snapshot ‚Üí crash with mdb_page_search\n4. Main app: Move new snapshot to final location\n```\n\nExtensions calling `Ndb(owns_db_file: false)` during this window will crash or see corrupt data.\n\n## The Solution (from PR #3564)\n\n**Snapshot Marker Protocol:**\n- Marker file: `snapshot.ready` signals snapshot is complete and safe to read\n- Main app workflow:\n  1. Remove marker (signals: snapshot invalid)\n  2. Delete old snapshot\n  3. Move new snapshot\n  4. Write marker (signals: snapshot ready)\n- Extension workflow:\n  - Check `snapshot_is_ready()` before opening\n  - Only open if marker exists\n\n## Comprehensive Testing Plan\n\n### Existing Tests (from PR #3564)\n\n‚úÖ **Unit Tests - Basic Marker Behavior:**\n- `testPerformSnapshot_CreatesMarkerFile` - Marker created after snapshot\n- `testNdb_WontOpenSnapshotWithoutMarker` - Ndb rejects snapshot without marker\n- `testNdb_OpensSnapshotWithMarker` - Ndb opens when marker exists\n- `testNdb_ExplicitPathReadonlyOpensWithoutMarker` - Explicit paths bypass check\n- `testPerformSnapshot_RemovesMarkerBeforeUpdate` - Marker lifecycle during updates\n\n### üéØ Additional Race Condition Tests to Add\n\n**Test 1: Concurrent Extension Opens During Update**\n```swift\nfunc testRaceCondition_ExtensionOpenDuringUpdate() async throws {\n    // Simulate 100 extension opens while snapshot updates\n    // Verify: No crashes, only success or safe nil returns\n}\n```\n\n**Test 2: Marker Ordering Verification**\n```swift\nfunc testMarkerRemovedBeforeSnapshotDelete() async throws {\n    // Verify marker removed BEFORE old snapshot deleted\n}\n\nfunc testMarkerWrittenAfterSnapshotMove() async throws {\n    // Verify marker written AFTER new snapshot in place\n}\n```\n\n**Test 3: Rapid Updates**\n```swift\nfunc testRapidUpdates_MarkerStateConsistent() async throws {\n    // 10 rapid updates, verify marker always consistent\n}\n```\n\n### E2E Testing Strategy\n\n**Manual Testing:**\n- [ ] Trigger snapshot update on device\n- [ ] Send notification during update\n- [ ] Verify notification displays (no crash)\n- [ ] Repeat 10+ times\n\n**Automated XCUITest:**\n```swift\nfunc testNotificationDuringSnapshotUpdate() {\n    // Trigger update + send notification\n    // Verify extension doesn't crash\n}\n```\n\n### Success Criteria\n\n- ‚úÖ All existing tests pass\n- ‚úÖ New race condition tests pass (100 iterations each)\n- ‚úÖ Manual device testing shows no crashes\n- ‚úÖ Code coverage ‚â• 95%\n- ‚úÖ CI runs all tests on every PR\n\n## Implementation Tasks\n\n1. Extract from PR #3564 commit 56092471:\n   - [ ] DatabaseSnapshotManager.swift - Marker management\n   - [ ] Ndb.swift - snapshot_is_ready() check\n   - [ ] DatabaseSnapshotManagerTests.swift - Existing marker tests\n\n2. Add new race condition tests:\n   - [ ] testRaceCondition_ExtensionOpenDuringUpdate\n   - [ ] testMarkerRemovedBeforeSnapshotDelete\n   - [ ] testMarkerWrittenAfterSnapshotMove\n   - [ ] testRapidUpdates_MarkerStateConsistent\n\n3. Verify and PR:\n   - [ ] All tests pass locally\n   - [ ] Build succeeds\n   - [ ] Test on device\n   - [ ] Create PR with test report\n\n## Related\n\n- Investigation: damus-wqp (closed)\n- Closed PR: https://github.com/damus-io/damus/pull/3564\n- Commit: 56092471\n- Depends on: PR #3614 (transaction retention)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T13:27:34.931585-06:00","created_by":"e","updated_at":"2026-02-10T14:23:40.675033-06:00","closed_at":"2026-02-10T14:23:40.675033-06:00","close_reason":"Snapshot marker protocol complete with all fixes:\n- Implemented marker file protocol in commits f954c36a and ecd5a49c\n- Fixed marker write failure handling (P2)\n- Fixed marker bypass issue (P2)\n- Added marker ordering test (P4)\n- Added compile-time constant verification\n- Added task cancellation checks\n- All 26 tests passing\nReady to push and create PR.","dependencies":[{"issue_id":"damus-zid","depends_on_id":"damus-wqp","type":"blocks","created_at":"2026-02-10T13:28:04.055209-06:00","created_by":"daemon"}]}
