{"id":"damus-0vp","title":"Phase 3: Create NdbNegentropyStorage to replace NegentropyStorageVector","description":"Replace the Swift NegentropyStorageVector with a wrapper around ndb_negentropy_storage that queries NostrDB directly.\n\nCurrent flow (inefficient):\n1. Query NDB for NoteKeys\n2. Load full events into memory\n3. Extract (id, created_at) \n4. Build NegentropyStorageVector\n\nNew flow (efficient):\n1. Create ndb_negentropy_storage\n2. Call ndb_negentropy_storage_from_filter(storage, txn, filter, limit)\n3. Storage is populated directly from LMDB index (zero-copy)\n\nThis eliminates ~200MB memory allocation for 50k events.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:11:26.544509-06:00","updated_at":"2025-12-17T10:36:21.554096-06:00","closed_at":"2025-12-17T10:36:21.554096-06:00","dependencies":[{"issue_id":"damus-0vp","depends_on_id":"damus-g26","type":"blocks","created_at":"2025-12-17T09:12:03.846698-06:00","created_by":"daemon"}]}
{"id":"damus-0wf","title":"Phase 1: Implement NIP-77 negentropy for timeline sync (new PR)","description":"Create new PR (separate from DM PR #3403) implementing negentropy sync for home timeline.\n\n**Trigger:** On app foreground (scenePhase == .active)\n\n**Key resources:**\n- damus-io/negentropy-swift library\n- NIP-77 spec (NEG-OPEN/NEG-MSG/NEG-CLOSE/NEG-ERR messages)\n- @alltheseas negentropy plan from issue #3269\n- @danieldaquino draft branch: https://github.com/danieldaquino/damus/tree/negentropy\n\n**Implementation approach (from #3269):**\n1. Define protocol surface: NEG message types, filter + hex payload encoding\n2. Embed negentropy session manager in RelayConnection/RelayPool\n3. Detect peer support, maintain per-subscription reconciliation state\n4. Fall back to legacy REQ when negotiation fails\n5. Add relay capability detection for NEG-ERR responses\n\n**Scope/limits for timeline:**\n- Recent window (e.g., last N hours)\n- Cap rounds and missing-ID budget\n- Batch-fetch missing IDs (e.g., 50 at a time)\n\n**Goal:** Reduce event volume on app restart from 5000+ to ~50-200 missing events","status":"in_progress","priority":2,"issue_type":"feature","created_at":"2025-12-16T11:09:46.835129-06:00","updated_at":"2025-12-16T11:20:23.109241-06:00"}
{"id":"damus-1sr","title":"Phase 4: Refactor NegentropySession to use ndb_negentropy","description":"Update NegentropySession actor to use the native nostrdb reconciliation engine instead of negentropy-swift.\n\nChanges to NegentropySession:\n- Replace Negentropy\u003cNegentropyStorageVector\u003e with ndb_negentropy context\n- Update initiate() to call ndb_negentropy_initiate()\n- Update processMessage() to call ndb_negentropy_reconcile()\n- Update getResults() to use ndb_negentropy_get_have_ids/need_ids\n- Handle hex encoding/decoding for NIP-77 wire format\n\nThe reconciliation state machine is now handled by C code, simplifying Swift logic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:11:33.223046-06:00","updated_at":"2025-12-17T10:36:21.555918-06:00","closed_at":"2025-12-17T10:36:21.555918-06:00","dependencies":[{"issue_id":"damus-1sr","depends_on_id":"damus-0vp","type":"blocks","created_at":"2025-12-17T09:12:03.902688-06:00","created_by":"daemon"}]}
{"id":"damus-2f0","title":"ROOT CAUSE: @MainActor isolation forces main thread hops","description":"RelayPool.swift has @MainActor on:\n- relays (line 35-36)\n- our_descriptors, all_descriptors, num_connected\n- get_relay, get_relays, getRelays\n- appendRelayToList, clearRelays, remove_relay\n\nEvery call to these from Task.detached still hops to main thread. During startup:\n1. add_relay calls appendRelayToList (@MainActor)\n2. connect() calls MainActor.run to get connections\n3. WebSocket events trigger DispatchQueue.main.async\n4. handle_event calls get_relay (@MainActor)\n\nCumulative effect: 75 hops, each queuing work, blocking main thread up to 5 seconds.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-16T10:26:06.548156-06:00","updated_at":"2025-12-16T10:26:06.548156-06:00","dependencies":[{"issue_id":"damus-2f0","depends_on_id":"damus-ev8","type":"discovered-from","created_at":"2025-12-16T10:26:15.247626-06:00","created_by":"daemon"}]}
{"id":"damus-4ch","title":"Note: Mode 3 bug doesn't affect client-side usage","description":"The IDLIST_RESPONSE (mode 3) bug fixed in nostrdb commit d1a1568 only affects server/relay implementations.\n\nAs a client, Damus:\n- Sends: NEG-OPEN with FINGERPRINT (mode 1) or IDLIST (mode 2)\n- Receives: FINGERPRINT (mode 1), IDLIST (mode 2), or SKIP (mode 0) from relays\n\nThe mode 3 bug was in nostrdb's reconcile() when responding to an incoming IDLIST - it was generating mode 3 instead of SKIP. This would only matter if nostrdb was used as a relay responding to client requests.\n\nFor our Phase 1 integration, we just need to ensure we pull commits through 82172d8 which includes all fixes. The current negentropy-swift library is correctly implementing client-side protocol.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T09:56:02.370452-06:00","updated_at":"2025-12-17T09:56:20.048364-06:00","closed_at":"2025-12-17T09:56:20.048364-06:00"}
{"id":"damus-5ny","title":"Phase 2: Integrate timeline negentropy with issue #3432 fix","description":"Replace current 'fetch everything since last timestamp' approach with negentropy reconciliation. Keep timestamp-based as fallback for relays without NIP-77 support. Add metrics to measure actual event reduction. Verify main thread blocking is reduced.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-16T11:09:47.031857-06:00","updated_at":"2025-12-16T11:09:47.031857-06:00","dependencies":[{"issue_id":"damus-5ny","depends_on_id":"damus-0wf","type":"blocks","created_at":"2025-12-16T11:09:53.819422-06:00","created_by":"daemon"}]}
{"id":"damus-6pu","title":"Fix main thread blocking on app startup (Issue #3432)","description":"App freezes for 5+ seconds on startup due to @MainActor blocking. MainThreadWatchdog shows 75 events, max 4965ms blocking. Root cause: RelayPool.relays is @MainActor isolated, causing main thread hops even from Task.detached.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-16T10:23:23.409664-06:00","updated_at":"2025-12-16T10:23:23.409664-06:00"}
{"id":"damus-9r7","title":"Phase 1: Update nostrdb submodule with negentropy support","description":"Update the nostrdb submodule in damus to include the native negentropy implementation.\n\n**Required commits (in order):**\n- 23377fa: Core data structures and encoding\n- 0c029b2: Unit tests for core encoding\n- eed5677: Range encoding/decoding\n- dbb10e6: Message encoding/decoding\n- f494685: Storage implementation\n- 075f26e: Reconciliation state machine\n- 54887be: Config struct and is_complete API\n- ac8eeb9: Filter-based storage initialization\n- d1a1568: **CRITICAL** - Fix NIP-77 protocol bugs (IDLIST encoding, SKIP response, Bound comparison, remove mode 3)\n- 82172d8: Security overflow guards\n\n**Key protocol fix in d1a1568:** The IDLIST_RESPONSE (mode 3) was removed because it's NOT in NIP-77 spec. Only modes 0-2 are valid. Our current Swift implementation may have this bug too.\n\nFiles to add to Xcode project:\n- src/ndb_negentropy.c\n- src/ndb_negentropy.h","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:11:09.190839-06:00","updated_at":"2025-12-17T10:11:19.060238-06:00","closed_at":"2025-12-17T10:11:19.060238-06:00"}
{"id":"damus-a74","title":"IMPL: Update UserRelayListManager to use batched methods","description":"Modify apply() to use addRelaysBatched/removeRelaysBatched instead of individual pool.add_relay calls in withTaskGroup.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-16T10:28:24.631609-06:00","updated_at":"2025-12-16T10:34:35.058571-06:00","dependencies":[{"issue_id":"damus-a74","depends_on_id":"damus-t5r","type":"parent-child","created_at":"2025-12-16T10:28:30.220181-06:00","created_by":"daemon"},{"issue_id":"damus-a74","depends_on_id":"damus-gby","type":"blocks","created_at":"2025-12-16T10:28:30.330572-06:00","created_by":"daemon"}]}
{"id":"damus-bsa","title":"Phase 6: Remove negentropy-swift dependency","description":"Remove the negentropy-swift SPM package dependency once native integration is complete.\n\nChanges:\n- Remove from Package.swift\n- Remove from Xcode project\n- Remove import Negentropy statements\n- Clean up any remaining references to NegentropyStorageVector, Negentropy\u003cT\u003e, Id types\n\nThis reduces app binary size and eliminates Swift-only fingerprint computation overhead.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:11:49.342496-06:00","updated_at":"2025-12-17T10:42:57.460674-06:00","closed_at":"2025-12-17T10:42:57.460674-06:00","dependencies":[{"issue_id":"damus-bsa","depends_on_id":"damus-v5f","type":"blocks","created_at":"2025-12-17T09:12:04.016516-06:00","created_by":"daemon"}]}
{"id":"damus-csk","title":"Analyze blocking pattern from watchdog output","description":"Pattern: 1029ms→179ms (dip at event 16)→grows to 4965ms. Events 1-16 show decreasing blocks during initial setup. Events 17+ show increasing blocks during network operations.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T10:23:29.338405-06:00","updated_at":"2025-12-16T10:25:56.537861-06:00","closed_at":"2025-12-16T10:25:56.537861-06:00","dependencies":[{"issue_id":"damus-csk","depends_on_id":"damus-6pu","type":"parent-child","created_at":"2025-12-16T10:23:47.282661-06:00","created_by":"daemon"}]}
{"id":"damus-cuo","title":"Integrate nostrdb native negentropy for NIP-77","description":"Replace Swift negentropy-swift library with nostrdb's native C implementation for NIP-77 set reconciliation. This provides 100x memory reduction (zero-copy from LMDB) and 10x faster fingerprinting (C SHA256 vs Swift). The native implementation lives in ~/develop/nostrdb/nostrdb with commits ac8eeb9..23377fa.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-17T09:10:59.001414-06:00","updated_at":"2025-12-17T10:43:11.950922-06:00","closed_at":"2025-12-17T10:43:11.950922-06:00"}
{"id":"damus-dws","title":"Design solution to eliminate main thread blocking","description":"Options: 1) Remove @MainActor from RelayPool.relays 2) Defer network init after first frame 3) Batch main thread updates 4) Use nonisolated for relay operations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T10:23:37.228251-06:00","updated_at":"2025-12-16T10:28:15.438265-06:00","closed_at":"2025-12-16T10:28:15.438265-06:00","dependencies":[{"issue_id":"damus-dws","depends_on_id":"damus-6pu","type":"parent-child","created_at":"2025-12-16T10:23:47.39584-06:00","created_by":"daemon"},{"issue_id":"damus-dws","depends_on_id":"damus-csk","type":"blocks","created_at":"2025-12-16T10:23:52.073267-06:00","created_by":"daemon"},{"issue_id":"damus-dws","depends_on_id":"damus-ev8","type":"blocks","created_at":"2025-12-16T10:23:52.129291-06:00","created_by":"daemon"}]}
{"id":"damus-ev8","title":"Investigate RelayPool @MainActor architecture","description":"RelayPool has @MainActor private(set) var relays. All relay operations hop to main thread regardless of Task.detached. Need to find alternative observation pattern.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T10:23:37.02651-06:00","updated_at":"2025-12-16T10:26:15.303455-06:00","closed_at":"2025-12-16T10:26:15.303455-06:00","dependencies":[{"issue_id":"damus-ev8","depends_on_id":"damus-6pu","type":"parent-child","created_at":"2025-12-16T10:23:47.339201-06:00","created_by":"daemon"}]}
{"id":"damus-ft7","title":"ROOT CAUSE: notify() floods main queue for every event","description":"Found the real root cause of escalating blocking:\n\n1. RelayPool.record_seen() calls notify(.update_stats(note_id:)) for EVERY nostr event\n2. notify() in Notify.swift uses DispatchQueue.main.async for ALL notifications  \n3. As WebSocket messages flood in, main queue gets overwhelmed\n\nThis explains the test pattern:\n- Events 1-16: decreasing (setup phase)\n- Events 17-58: escalating 400ms→4800ms (incoming message flood)\n\nSolutions:\nA) Throttle update_stats: Collect note IDs, flush every 100ms\nB) Remove update_stats from hot path\nC) Make stats updates lazy (only when note is viewed)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T10:45:23.669338-06:00","updated_at":"2025-12-16T11:17:00.815482-06:00","closed_at":"2025-12-16T11:17:00.815482-06:00"}
{"id":"damus-g26","title":"Phase 2: Add Swift bindings for ndb_negentropy C API","description":"Create Swift bridging for the nostrdb negentropy C functions. Add to Ndb.swift or create new NdbNegentropy.swift:\n\nKey functions to wrap:\n- ndb_negentropy_storage_init/destroy\n- ndb_negentropy_storage_from_filter (main integration point)\n- ndb_negentropy_storage_seal\n- ndb_negentropy_init/destroy\n- ndb_negentropy_initiate\n- ndb_negentropy_reconcile\n- ndb_negentropy_is_complete\n- ndb_negentropy_get_have_ids/get_need_ids\n\nSwift wrapper should:\n- Handle memory management safely\n- Convert between Swift types and C pointers\n- Provide idiomatic Swift API","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:11:17.885829-06:00","updated_at":"2025-12-17T10:28:54.99407-06:00","closed_at":"2025-12-17T10:28:54.99407-06:00","dependencies":[{"issue_id":"damus-g26","depends_on_id":"damus-9r7","type":"blocks","created_at":"2025-12-17T09:12:03.786549-06:00","created_by":"daemon"}]}
{"id":"damus-gby","title":"IMPL: Add batched relay methods to RelayPool","description":"Add addRelaysBatched() and removeRelaysBatched() methods that do ONE @MainActor hop for all relays instead of per-relay hops.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-16T10:28:24.437873-06:00","updated_at":"2025-12-16T10:28:34.799248-06:00","dependencies":[{"issue_id":"damus-gby","depends_on_id":"damus-t5r","type":"parent-child","created_at":"2025-12-16T10:28:30.16464-06:00","created_by":"daemon"}]}
{"id":"damus-j4e","title":"Phase 7: Test and validate native negentropy integration","description":"Comprehensive testing of native negentropy integration.\n\nTest scenarios:\n1. Fresh app install - initial sync with multiple relays\n2. App foreground resume - incremental sync\n3. Relay reconnection - single relay sync  \n4. Poor network conditions - timeout handling\n5. Large dataset - 50k+ events performance test\n6. Memory profiling - verify reduced memory footprint\n\nValidation:\n- Compare sync results with previous Swift implementation\n- Measure memory usage before/after\n- Measure sync time before/after\n- Test relay.damus.io, pyramid.fiatjaf.com compatibility\n- Verify NIP-77 protocol compliance","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:11:57.678968-06:00","updated_at":"2025-12-17T10:43:11.891822-06:00","closed_at":"2025-12-17T10:43:11.891822-06:00","dependencies":[{"issue_id":"damus-j4e","depends_on_id":"damus-bsa","type":"blocks","created_at":"2025-12-17T09:12:04.074239-06:00","created_by":"daemon"}]}
{"id":"damus-l7m","title":"Phase 3: Harden timeline negentropy implementation","description":"Add unit tests for negentropy message parsing. Add integration tests with mock relay. Review negentropy-swift library for correctness. Handle edge cases: relay disconnects mid-sync, timeouts, partial sync recovery. Document relay NIP-77 support status.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-16T11:09:47.228459-06:00","updated_at":"2025-12-16T11:09:47.228459-06:00","dependencies":[{"issue_id":"damus-l7m","depends_on_id":"damus-5ny","type":"blocks","created_at":"2025-12-16T11:09:53.875146-06:00","created_by":"daemon"}]}
{"id":"damus-qax","title":"Investigate NIP-77 (Negentropy sync) implementations for issue #3432","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:04:57.593698-06:00","updated_at":"2025-12-16T11:10:17.102839-06:00","closed_at":"2025-12-16T11:10:17.102839-06:00"}
{"id":"damus-qwu","title":"IMPL: Defer network init until after first frame","description":"Modify ContentView to show loading UI immediately, then start network init after first frame renders using onAppear or similar.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-16T10:28:24.832109-06:00","updated_at":"2025-12-16T10:28:24.832109-06:00","dependencies":[{"issue_id":"damus-qwu","depends_on_id":"damus-t5r","type":"parent-child","created_at":"2025-12-16T10:28:30.275396-06:00","created_by":"daemon"}]}
{"id":"damus-t5r","title":"Implement and test fix","description":"Implement chosen solution and verify with MainThreadWatchdog that blocking is eliminated or greatly reduced.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-16T10:23:37.434236-06:00","updated_at":"2025-12-16T10:28:24.244759-06:00","dependencies":[{"issue_id":"damus-t5r","depends_on_id":"damus-6pu","type":"parent-child","created_at":"2025-12-16T10:23:47.451595-06:00","created_by":"daemon"},{"issue_id":"damus-t5r","depends_on_id":"damus-dws","type":"blocks","created_at":"2025-12-16T10:23:52.186917-06:00","created_by":"daemon"}]}
{"id":"damus-tfh","title":"DESIGN: Batch @MainActor operations and defer network init","description":"Problem: Each relay add/remove triggers separate @MainActor hop. 10 relays = 10+ hops accumulating on main thread.\n\nSolution (2 parts):\n\nPART 1: Batch relay operations in RelayPool\n- Add addRelaysBatched([RelayDescriptor]) - ONE @MainActor hop for all\n- Add removeRelaysBatched([RelayURL]) - ONE @MainActor hop for all  \n- Modify UserRelayListManager.apply() to use batched methods\n\nPART 2: Defer network initialization\n- Show loading UI immediately in ContentView\n- Only start network after first frame renders\n- Use onAppear or DispatchQueue.main.async after state set\n\nThis reduces ~20+ hops to ~3-4 hops AND ensures UI is responsive during init.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-16T10:27:59.802854-06:00","updated_at":"2025-12-16T10:27:59.802854-06:00","dependencies":[{"issue_id":"damus-tfh","depends_on_id":"damus-dws","type":"discovered-from","created_at":"2025-12-16T10:28:15.382652-06:00","created_by":"daemon"}]}
{"id":"damus-v5f","title":"Phase 5: Update NegentropyManager for native integration","description":"Update NegentropyManager to work with the new native storage.\n\nChanges:\n- Remove getLocalEvents() method (no longer needed)\n- Update syncWithRelay() to create ndb_negentropy_storage from filter\n- Pass NdbTxn to storage initialization\n- Ensure transaction lifecycle is managed correctly\n- Update syncTimelineWithNegentropy() in NostrNetworkManager\n\nKey benefit: No more loading 50k events into Swift memory. The storage queries LMDB directly via ndb_query() in C.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:11:42.973015-06:00","updated_at":"2025-12-17T10:36:21.556559-06:00","closed_at":"2025-12-17T10:36:21.556559-06:00","dependencies":[{"issue_id":"damus-v5f","depends_on_id":"damus-1sr","type":"blocks","created_at":"2025-12-17T09:12:03.960298-06:00","created_by":"daemon"}]}
