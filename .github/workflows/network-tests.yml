name: Network Condition Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  # Allow manual trigger with profile selection
  workflow_dispatch:
    inputs:
      network_profile:
        description: 'Network profile to simulate'
        required: true
        default: '3g'
        type: choice
        options:
          - 3g
          - 3gslow
          - edge
          - verybad

jobs:
  network-tests:
    name: Tests under ${{ github.event.inputs.network_profile || '3g' }} conditions
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install throttle
        run: npm install -g @sitespeed.io/throttle

      - name: Start network throttling
        run: |
          PROFILE="${{ github.event.inputs.network_profile || '3g' }}"
          echo "Starting network throttle with profile: $PROFILE"
          sudo throttle --profile $PROFILE
          echo "Network throttling enabled"

      - name: Boot Simulator
        run: |
          # Boot simulator before tests to ensure it's ready
          xcrun simctl boot "iPhone 15" || true
          # Wait for simulator to be fully booted
          xcrun simctl bootstatus "iPhone 15" -b

      - name: Run Tests under throttled network
        run: |
          xcodebuild test \
            -scheme damus \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -resultBundlePath NetworkTestResults.xcresult \
            -only-testing:damusTests/UploadRetryTests \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color
        # Note: Add more test targets as WebSocket tests are developed:
        # -only-testing:damusTests/RelayConnectionTests \
        # -only-testing:damusTests/RelayPoolTests \

      - name: Stop network throttling
        if: always()
        run: |
          sudo throttle --stop || true
          echo "Network throttling disabled"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: network-test-results-${{ github.event.inputs.network_profile || '3g' }}
          path: NetworkTestResults.xcresult

  # Optional: Run tests under multiple network profiles
  matrix-network-tests:
    name: Matrix - ${{ matrix.profile }} network
    runs-on: macos-14
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    strategy:
      fail-fast: false
      matrix:
        profile: [3g, edge]

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install throttle
        run: npm install -g @sitespeed.io/throttle

      - name: Start ${{ matrix.profile }} throttling
        run: sudo throttle --profile ${{ matrix.profile }}

      - name: Boot Simulator
        run: |
          xcrun simctl boot "iPhone 15" || true
          xcrun simctl bootstatus "iPhone 15" -b

      - name: Run Tests
        run: |
          xcodebuild test \
            -scheme damus \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -resultBundlePath NetworkTestResults-${{ matrix.profile }}.xcresult \
            -only-testing:damusTests/UploadRetryTests \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color

      - name: Stop throttling
        if: always()
        run: sudo throttle --stop || true

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: network-test-results-${{ matrix.profile }}
          path: NetworkTestResults-${{ matrix.profile }}.xcresult
